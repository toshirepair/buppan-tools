<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>仕入れ上限まで出る 為替×手数料電卓</title>
  <style>
    :root { --bd:#e5e7eb; --fg:#111827; --muted:#6b7280; --bg:#ffffff; --chip:#f3f4f6; }
    body{ font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background:var(--bg); color:var(--fg); margin:0; padding:16px; }
    .wrap{ max-width:860px; margin:0 auto; }
    h1{ font-size:1.15rem; margin:0 0 10px; }
    .card{ border:1px solid var(--bd); border-radius:14px; padding:14px; box-shadow:0 1px 0 rgba(0,0,0,.02); }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    button.chip{
      border:1px solid var(--bd); background:var(--chip); padding:10px 12px; border-radius:999px;
      font-size:1rem; cursor:pointer;
    }
    button.chip.active{ background:#111827; color:#fff; border-color:#111827; }
    .grid{ display:grid; gap:10px; }
    @media (min-width: 780px){ .grid.cols2{ grid-template-columns: 1fr 1fr; } }
    .input, select{
      width:100%; border:1px solid var(--bd); border-radius:12px; padding:12px;
      font-size:1rem; outline:none; background:#fff;
    }
    .sub{ color:var(--muted); font-size:.9rem; margin-top:8px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .box{ border:1px solid var(--bd); border-radius:12px; padding:12px; }
    .k{ color:var(--muted); font-size:.85rem; }
    .v{ font-size:1.25rem; margin-top:4px; }
    .btn{ border:1px solid var(--bd); background:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; }
    .ok{ color:#059669; } .err{ color:#b91c1c; }
    .toggle{ display:flex; align-items:center; gap:8px; user-select:none; }
    .toggle input{ transform: scale(1.15); }
    .small{ font-size:.85rem; color:var(--muted); }
    .hr{ height:1px; background:var(--bd); margin:10px 0; }
  </style>
</head>
<body>
<div class="wrap">
  <h1>仕入れ上限まで出る 為替×手数料電卓（JPY / USD / EUR）</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="chips" role="tablist" aria-label="入力通貨の選択">
        <button class="chip active" data-cur="JPY" aria-selected="true">¥ JPY</button>
        <button class="chip" data-cur="USD" aria-selected="false">$ USD</button>
        <button class="chip" data-cur="EUR" aria-selected="false">€ EUR</button>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="refresh" class="btn">レート更新</button>
        <button id="swap" class="btn">入力通貨切替</button>
      </div>
    </div>

    <div class="grid cols2" style="margin-top:10px;">
      <div class="box">
        <div class="k">① 売価（入力）</div>
        <input id="amount" class="input" inputmode="decimal" placeholder="金額を入力（例：120000）" />
        <div class="sub">
          <div>レート：<span id="rateStatus" class="ok">読み込み中…</span></div>
          <div class="k" id="rateText"></div>
        </div>
      </div>

      <div class="box">
        <div class="k">② 販売先</div>
        <select id="market" class="input">
          <option value="ebay">eBay</option>
          <option value="catawiki">Catawiki</option>
          <option value="domestic">ヤフオク・メルカリ</option>
        </select>
        <div class="small" id="marketHint" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid cols2">
      <div class="box">
        <div class="k">③ 手数料（ON/OFF）</div>
        <div class="row" style="margin-top:8px;">
          <label class="toggle"><input type="checkbox" id="onEbayFee" checked> eBay手数料</label>
          <label class="toggle"><input type="checkbox" id="onPayoneer" checked> Payoneer</label>
          <label class="toggle"><input type="checkbox" id="onCataFee"> Catawiki手数料</label>
          <label class="toggle"><input type="checkbox" id="onDomesticFee"> ヤフオク・メルカリ手数料</label>
        </div>

        <div class="grid cols2" style="margin-top:10px;">
          <div>
            <div class="k">eBay手数料（%）</div>
            <input id="ebayPct" class="input" inputmode="decimal" value="20.00" />
          </div>
          <div>
            <div class="k">Payoneer（%）</div>
            <input id="payoneerPct" class="input" inputmode="decimal" value="2.00" />
          </div>

          <div>
            <div class="k">Catawiki手数料（%）</div>
            <input id="cataPct" class="input" inputmode="decimal" value="15.00" />
          </div>
          <div>
            <div class="k">ヤフオク・メルカリ手数料（%）</div>
            <input id="domesticPct" class="input" inputmode="decimal" value="10.00" />
          </div>
        </div>

        <div class="small" style="margin-top:8px;">
          ※「販売先」を変えると、必要な手数料だけ自動でONになります（必要なら手動で変更OK）
        </div>
      </div>

      <div class="box">
        <div class="k">④ 送料・関税（任意）</div>
        <div class="row" style="margin-top:8px;">
          <label class="toggle"><input type="checkbox" id="onShip"> 送料を差し引く</label>
          <label class="toggle"><input type="checkbox" id="onDuty"> 関税を差し引く</label>
        </div>

        <div class="grid cols2" style="margin-top:10px;">
          <div>
            <div class="k">送料（JPY）</div>
            <input id="shipJpy" class="input" inputmode="decimal" value="0" />
          </div>
          <div>
            <div class="k">関税（JPY）</div>
            <input id="dutyJpy" class="input" inputmode="decimal" value="0" />
          </div>
        </div>
        <div class="small" id="dduNote" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="grid cols2">
      <div class="box">
        <div class="k">換算表示</div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1;">
            <div class="k">JPY</div><div class="v" id="outJPY">—</div>
          </div>
          <div style="flex:1;">
            <div class="k">USD</div><div class="v" id="outUSD">—</div>
          </div>
          <div style="flex:1;">
            <div class="k">EUR</div><div class="v" id="outEUR">—</div>
          </div>
        </div>
      </div>

      <div class="box">
        <div class="k">仕入れ判断（JPY）</div>
        <div class="row" style="margin-top:8px;">
          <div style="flex:1;">
            <div class="k">入金額（手数料後）</div>
            <div class="v" id="payoutJpy">—</div>
          </div>
          <div style="flex:1;">
            <div class="k">仕入れ上限目安（=入金−送料−関税）</div>
            <div class="v" id="maxBuyJpy">—</div>
          </div>
        </div>
        <div class="small" id="feeBreak" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <p class="sub" style="margin-top:10px;">
    ※ レート取得できない時は直近レートのまま計算します（キャッシュ対応）。
  </p>
</div>

<script>
(() => {
  // ===== FX Cache Settings =====
  const FX_CACHE_KEY = "fx_cache_eur_jpy_usd_v1";
  const FX_CACHE_TTL_MS = 10 * 60 * 1000; // 10分

  const readFxCache = () => {
    try {
      const raw = localStorage.getItem(FX_CACHE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !obj.rates || !obj.ts) return null;
      return obj;
    } catch {
      return null;
    }
  };

  const writeFxCache = (payload) => {
    try {
      localStorage.setItem(FX_CACHE_KEY, JSON.stringify(payload));
    } catch {
      // 容量・制限などで失敗しても無視（機能は落ちない）
    }
  };

  // ===== state =====
  let active = "JPY";
  let eurToJpy = null;
  let eurToUsd = null;
  let lastDate = null;
  let lastFetchedAt = null;

  // ===== els =====
  const elAmount = document.getElementById("amount");
  const elRateStatus = document.getElementById("rateStatus");
  const elRateText = document.getElementById("rateText");
  const elOutJPY = document.getElementById("outJPY");
  const elOutUSD = document.getElementById("outUSD");
  const elOutEUR = document.getElementById("outEUR");

  const elMarket = document.getElementById("market");
  const elMarketHint = document.getElementById("marketHint");
  const elDDUNote = document.getElementById("dduNote");

  const onEbayFee = document.getElementById("onEbayFee");
  const onPayoneer = document.getElementById("onPayoneer");
  const onCataFee = document.getElementById("onCataFee");
  const onDomesticFee = document.getElementById("onDomesticFee");

  const ebayPct = document.getElementById("ebayPct");
  const payoneerPct = document.getElementById("payoneerPct");
  const cataPct = document.getElementById("cataPct");
  const domesticPct = document.getElementById("domesticPct");

  const onShip = document.getElementById("onShip");
  const onDuty = document.getElementById("onDuty");
  const shipJpy = document.getElementById("shipJpy");
  const dutyJpy = document.getElementById("dutyJpy");

  const payoutJpy = document.getElementById("payoutJpy");
  const maxBuyJpy = document.getElementById("maxBuyJpy");
  const feeBreak = document.getElementById("feeBreak");

  // ===== helpers =====
  const fmt = (currency, n) => {
    if (!isFinite(n)) return "—";
    const opt = { style: "currency", currency };
    if (currency === "JPY") opt.maximumFractionDigits = 0;
    return new Intl.NumberFormat("ja-JP", opt).format(n);
  };

  const parseNumber = (s) => {
    if (s === null || s === undefined) return NaN;
    const cleaned = String(s).replace(/[¥$€,\s]/g, "").replace(/[^\d.-]/g, "");
    return cleaned ? Number(cleaned) : NaN;
  };

  const pctToRate = (pct) => {
    const p = parseNumber(pct);
    return isFinite(p) ? (p / 100) : 0;
  };

  const setActive = (cur) => {
    active = cur;
    document.querySelectorAll("button.chip").forEach(btn => {
      const on = btn.dataset.cur === cur;
      btn.classList.toggle("active", on);
      btn.setAttribute("aria-selected", on ? "true" : "false");
    });
    elAmount.placeholder = cur === "JPY" ? "金額を入力（円）" : (cur === "USD" ? "金額を入力（USD）" : "金額を入力（EUR）");
    recalcAll();
  };

  const getCrossRates = () => {
    if (!(eurToJpy && eurToUsd)) return null;
    const jpyToEur = 1 / eurToJpy;
    const usdToEur = 1 / eurToUsd;
    const jpyToUsd = eurToUsd / eurToJpy;
    const usdToJpy = eurToJpy / eurToUsd;
    return { eurToJpy, eurToUsd, jpyToEur, usdToEur, jpyToUsd, usdToJpy };
  };

  const amountToJPY = (amount, r) => {
    if (!isFinite(amount) || !r) return NaN;
    if (active === "JPY") return amount;
    if (active === "USD") return amount * r.usdToJpy;
    return amount * r.eurToJpy;
  };

  const setRateUI = (ok, msg, cacheInfo = "") => {
    elRateStatus.textContent = msg + (cacheInfo ? ` ${cacheInfo}` : "");
    elRateStatus.className = ok ? "ok" : "err";
    if (ok && eurToJpy && eurToUsd) {
      const jpyToUsd = eurToUsd / eurToJpy;
      elRateText.textContent =
        `EUR→JPY=${eurToJpy.toFixed(4)} / EUR→USD=${eurToUsd.toFixed(6)} / JPY→USD=${jpyToUsd.toFixed(6)} (date:${lastDate || "—"})`;
    } else {
      elRateText.textContent = "";
    }
  };

  const applyMarketDefaultsUI = () => {
    const m = elMarket.value;

    onEbayFee.checked = false;
    onPayoneer.checked = false;
    onCataFee.checked = false;
    onDomesticFee.checked = false;

    elDDUNote.textContent = "";

    if (m === "ebay") {
      elMarketHint.textContent = "eBay：eBay手数料(20%)＋Payoneer(2%) を差し引いて入金額を算出";
      onEbayFee.checked = true;
      onPayoneer.checked = true;
    } else if (m === "catawiki") {
      elMarketHint.textContent = "Catawiki：Catawiki手数料(15%) を差し引いて入金額を算出（DDUなら関税は基本OFF）";
      onCataFee.checked = true;
      onDuty.checked = false;
      elDDUNote.textContent = "DDU運用なら、関税は原則バイヤー負担 → ここはOFFのままが基本。";
    } else {
      elMarketHint.textContent = "ヤフオク・メルカリ：手数料(10%) を差し引いて入金額を算出";
      onDomesticFee.checked = true;
    }
  };

  const recalcAll = () => {
    const amount = parseNumber(elAmount.value);
    const r = getCrossRates();

    if (!isFinite(amount) || !r) {
      elOutJPY.textContent = isFinite(amount) && active === "JPY" ? fmt("JPY", amount) : "—";
      elOutUSD.textContent = isFinite(amount) && active === "USD" ? fmt("USD", amount) : "—";
      elOutEUR.textContent = isFinite(amount) && active === "EUR" ? fmt("EUR", amount) : "—";
      payoutJpy.textContent = "—";
      maxBuyJpy.textContent = "—";
      feeBreak.textContent = "";
      return;
    }

    // FX display
    let jpy, usd, eur;
    if (active === "JPY") { jpy = amount; usd = amount * r.jpyToUsd; eur = amount * r.jpyToEur; }
    else if (active === "USD") { usd = amount; jpy = amount * r.usdToJpy; eur = amount * r.usdToEur; }
    else { eur = amount; jpy = amount * r.eurToJpy; usd = amount * r.eurToUsd; }

    elOutJPY.textContent = fmt("JPY", jpy);
    elOutUSD.textContent = fmt("USD", usd);
    elOutEUR.textContent = fmt("EUR", eur);

    // payout calc
    const grossJpy = amountToJPY(amount, r);

    const ebayFee = onEbayFee.checked ? grossJpy * pctToRate(ebayPct.value) : 0;
    const payoFee = onPayoneer.checked ? grossJpy * pctToRate(payoneerPct.value) : 0;
    const cataFeeVal = onCataFee.checked ? grossJpy * pctToRate(cataPct.value) : 0;
    const domesticFeeVal = onDomesticFee.checked ? grossJpy * pctToRate(domesticPct.value) : 0;

    const payout = grossJpy - (ebayFee + payoFee + cataFeeVal + domesticFeeVal);

    const ship = (onShip.checked ? parseNumber(shipJpy.value) : 0) || 0;
    const duty = (onDuty.checked ? parseNumber(dutyJpy.value) : 0) || 0;

    const maxBuy = payout - ship - duty;

    payoutJpy.textContent = fmt("JPY", payout);
    maxBuyJpy.textContent = fmt("JPY", maxBuy);

    const parts = [];
    if (onEbayFee.checked) parts.push(`eBay: -${fmt("JPY", ebayFee)}`);
    if (onPayoneer.checked) parts.push(`Payoneer: -${fmt("JPY", payoFee)}`);
    if (onCataFee.checked) parts.push(`Catawiki: -${fmt("JPY", cataFeeVal)}`);
    if (onDomesticFee.checked) parts.push(`ヤフオク/メルカリ: -${fmt("JPY", domesticFeeVal)}`);
    if (onShip.checked) parts.push(`送料: -${fmt("JPY", ship)}`);
    if (onDuty.checked) parts.push(`関税: -${fmt("JPY", duty)}`);

    feeBreak.textContent = `売価(円換算) ${fmt("JPY", grossJpy)} → ${parts.length ? parts.join(" / ") + " → " : ""}仕入上限目安 ${fmt("JPY", maxBuy)}`;
  };

  const applyRates = (eurJpy, eurUsd, dateStr) => {
    eurToJpy = Number(eurJpy);
    eurToUsd = Number(eurUsd);
    lastDate = dateStr || null;
    lastFetchedAt = new Date();
  };

  const fetchRates = async (force = false) => {
    // 1) キャッシュが新しければそれを使う
    const cache = readFxCache();
    const now = Date.now();
    if (!force && cache && cache.ts && (now - cache.ts) < FX_CACHE_TTL_MS) {
      applyRates(cache.rates.JPY, cache.rates.USD, cache.date);
      const ageSec = Math.floor((now - cache.ts) / 1000);
      setRateUI(true, `OK（${new Date(cache.ts).toLocaleString("ja-JP")}）`, `- cache(${Math.floor(ageSec/60)}m)`);
      recalcAll();
      return;
    }

    // 2) API取得に挑戦
    try {
      setRateUI(true, "更新中…");
      const url = "https://api.frankfurter.dev/latest?from=EUR&to=JPY,USD";
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      if (!data || !data.rates || !data.rates.JPY || !data.rates.USD) throw new Error("invalid response");

      applyRates(data.rates.JPY, data.rates.USD, data.date);

      // キャッシュ保存
      writeFxCache({
        ts: Date.now(),
        date: data.date || null,
        rates: { JPY: Number(data.rates.JPY), USD: Number(data.rates.USD) }
      });

      setRateUI(true, `OK（${lastFetchedAt.toLocaleString("ja-JP")}）`);
      recalcAll();
    } catch (e) {
      // 3) API失敗 → キャッシュがあればそれを使う（期限切れでもOK）
      const stale = readFxCache();
      if (stale && stale.rates && stale.rates.JPY && stale.rates.USD) {
        applyRates(stale.rates.JPY, stale.rates.USD, stale.date);
        setRateUI(false, "取得失敗（キャッシュで継続）", `- cache`);
        recalcAll();
        return;
      }

      // 4) それも無い → 表示だけ落として継続
      setRateUI(false, "取得失敗（直近レートなし）");
      recalcAll();
    }
  };

  // ===== events =====
  document.querySelectorAll("button.chip").forEach(btn => {
    btn.addEventListener("click", () => setActive(btn.dataset.cur));
  });

  elAmount.addEventListener("input", recalcAll);

  document.getElementById("refresh").addEventListener("click", () => fetchRates(true)); // 強制更新
  document.getElementById("swap").addEventListener("click", () => {
    const order = ["JPY","USD","EUR"];
    setActive(order[(order.indexOf(active) + 1) % order.length]);
  });

  elMarket.addEventListener("change", () => {
    applyMarketDefaultsUI();
    recalcAll();
  });

  [
    onEbayFee, onPayoneer, onCataFee, onDomesticFee,
    ebayPct, payoneerPct, cataPct, domesticPct,
    onShip, onDuty, shipJpy, dutyJpy
  ].forEach(el => el.addEventListener("input", recalcAll));

  // ===== init =====
  setActive("JPY");
  applyMarketDefaultsUI();

  // 起動時：まずキャッシュ優先（10分以内ならAPI叩かない）
  fetchRates(false);

  // 1時間ごとに「キャッシュ優先」で更新（大量同時アクセス時の負荷を抑える）
  setInterval(() => fetchRates(false), 60 * 60 * 1000);
})();
</script>
</body>
</html>
