<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bid Limit Calculator</title>
<style>
  *{ box-sizing:border-box; }
  body{
    font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
    background:#fff;
    margin:0;
    padding:16px;
  }
  .wrap{ max-width:760px; margin:auto; }
  h1{ font-size:1.35rem; margin:0 0 12px; }

  .card{
    border:1px solid #ddd;
    border-radius:14px;
    padding:14px;
    margin-bottom:12px;
    background:#fff;
  }
  .k{ font-size:.85rem; color:#666; }
  .small{ font-size:.82rem; color:#777; margin-top:6px; line-height:1.35; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .grid2{
    display:grid;
    grid-template-columns: 1fr;
    gap:10px;
  }
  @media (min-width: 680px){
    .grid2{ grid-template-columns: 1fr 1fr; }
  }

  .input, select{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    margin-top:4px;
    font-size:1rem;
    background:#fff;
  }

  /* 為替レート入力：デフォ薄グレー → 入力で白 */
  .rateInput{
    background:#f1f1f1;
    transition: background .15s ease;
  }
  .rateInput.filled{ background:#fff; }

  button.chip{
    border:1px solid #ccc;
    border-radius:999px;
    padding:8px 14px;
    background:#f3f3f3;
    cursor:pointer;
  }
  button.chip.active{
    background:#111;
    color:#fff;
    border-color:#111;
  }

  .moneyWrap{
    display:flex;
    align-items:center;
    width:100%;
    border:1px solid #ccc;
    border-radius:10px;
    overflow:hidden;
    margin-top:4px;
    background:#fff;
  }
  .prefix{
    padding:10px 12px;
    border-right:1px solid #e5e5e5;
    color:#333;
    background:#fafafa;
    min-width:44px;
    text-align:center;
    font-weight:600;
  }
  .moneyInput{
    border:0;
    outline:none;
    width:100%;
    padding:10px 12px;
    font-size:1rem;
    background:#fff;
  }

  .v{ font-size:1.55rem; font-weight:800; margin-top:6px; }
  .bidValue{
    color:#1d4ed8;
    cursor:pointer;
    user-select:none;
  }
  .bidValue:active{ opacity:.7; }

  .btn{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    background:#f6f6f6;
    cursor:pointer;
    margin-top:10px;
    font-size:0.95rem;
  }
  .btn:active{ opacity:.8; }

  .breakdown{
    margin-top:10px;
    border-top:1px solid #eee;
    padding-top:10px;
  }
  .line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:4px 0;
    font-size:0.95rem;
  }
  .line .l{ color:#444; }
  .line .r{ font-weight:600; }
  .muted{ color:#777; font-weight:500; }
  .warn{ color:#b91c1c; }

  .linkBtn{
    border:1px solid #ccc;
    background:#fff;
    border-radius:10px;
    padding:9px 12px;
    cursor:pointer;
    text-decoration:none;
    display:inline-block;
    color:#111;
    font-size:.95rem;
  }
  .linkBtn:active{ opacity:.8; }

  .sectionTitle{
    font-weight:700;
    font-size:.92rem;
    color:#333;
    margin-bottom:6px;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Bid Limit Calculator</h1>

  <!-- ① 為替（手動） -->
  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div class="k">① 為替レート（手動入力）</div>
      <a class="linkBtn" id="mufgLink" href="https://www.bk.mufg.jp/ippan/rate/real.html" target="_blank" rel="noopener">
        為替レートを見る（MUFG）
      </a>
    </div>

    <div class="grid2" style="margin-top:8px;">
      <div>
        <div class="k">1 USD = JPY</div>
        <input id="usdJpy" class="input rateInput" inputmode="decimal" placeholder="例：156">
      </div>
      <div>
        <div class="k">1 EUR = JPY</div>
        <input id="eurJpy" class="input rateInput" inputmode="decimal" placeholder="例：183">
      </div>
    </div>
    <div class="small">※ 入力したレートは、このブラウザに自動保存されます</div>
  </div>

  <!-- ② 販売先 + ③ 売価通貨・売価（同じ枠） -->
  <div class="card">
    <div class="sectionTitle">② 販売先・③ 売価通貨・売価</div>

    <div class="k">販売先</div>
    <select id="market" class="input">
      <option value="ebay">eBay</option>
      <option value="catawiki">catawiki</option>
      <option value="domestic">ヤフオク・メルカリ</option>
    </select>
    <div class="small" id="feeNote">—</div>

    <div class="k" style="margin-top:12px;">売価通貨</div>
    <div class="row" style="margin-top:8px;">
      <button class="chip active" data-cur="JPY">JPY</button>
      <button class="chip" data-cur="USD">USD</button>
      <button class="chip" data-cur="EUR">EUR</button>
    </div>

    <div class="k" style="margin-top:10px;">売価</div>
    <div class="moneyWrap">
      <div class="prefix" id="amountPrefix">¥</div>
      <input id="amount" class="moneyInput" inputmode="decimal" placeholder="例：20000">
    </div>
    <div class="small" id="fxNeedHint"></div>
  </div>

  <!-- ④ 利益・コスト -->
  <div class="card">
    <div class="k">④ 利益・コスト</div>

    <div class="k" style="margin-top:8px;">
      <label>
        <input type="checkbox" id="taxCheck">
        消費税10％ ※ストア出品者から買う時に入力する
      </label>
    </div>

    <div class="grid2" style="margin-top:10px;">
      <div>
        <div class="k">利益（JPY）</div>
        <input id="profit" class="input" inputmode="decimal" value="10000">
      </div>
      <div>
        <div class="k">送料（JPY）※送料込みで売る時に入力する</div>
        <input id="ship" class="input" inputmode="decimal" value="0">
      </div>
      <div style="grid-column:1 / -1;">
        <div class="k">関税（JPY）※DDPセラー払いの時に入力する</div>
        <input id="duty" class="input" inputmode="decimal" value="0">
      </div>
    </div>
  </div>

  <!-- 結果 -->
  <div class="card">
    <div class="k">仕入（入札上限）※タップでコピー</div>
    <div class="v bidValue" id="bidLimit">—</div>
    <div class="small" id="copyMsg"></div>

    <div class="breakdown">
      <div class="k">内訳（円換算）</div>
      <div class="small muted" id="grossHint">—</div>

      <div class="line"><div class="l">販売先</div><div class="r" id="bMarket">—</div></div>
      <div class="line"><div class="l">売価</div><div class="r" id="bGross">—</div></div>
      <div class="line"><div class="l">手数料</div><div class="r" id="bFee">—</div></div>
      <div class="line"><div class="l">入金額</div><div class="r" id="bPayout">—</div></div>
      <div class="line"><div class="l">送料</div><div class="r" id="bShip">—</div></div>
      <div class="line"><div class="l">関税</div><div class="r" id="bDuty">—</div></div>
      <div class="line"><div class="l">仕入（入札上限）</div><div class="r" id="bBid">—</div></div>
      <div class="line"><div class="l">利益</div><div class="r" id="bProfit">—</div></div>

      <button class="btn" id="copyAllBtn">結果をコピー</button>
      <div class="small" id="copyAllMsg"></div>

      <div class="small warn" id="errMsg"></div>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== keys =====
  const K = {
    active: "blc_active_v3",
    market: "blc_market_v3",
    amount: "blc_amount_v3",
    usdJpy: "blc_usdJpy_v3",
    eurJpy: "blc_eurJpy_v3",
    profit: "blc_profit_v3",
    ship: "blc_ship_v3",
    duty: "blc_duty_v3",
    tax: "blc_tax_v3",
    lastFxFocus: "blc_lastFxFocus_v3", // "USD" or "EUR"
  };

  // ===== els =====
  const chips = document.querySelectorAll(".chip");
  const amountPrefix = document.getElementById("amountPrefix");
  const amountEl = document.getElementById("amount");
  const marketEl = document.getElementById("market");
  const feeNoteEl = document.getElementById("feeNote");
  const fxNeedHint = document.getElementById("fxNeedHint");

  const usdJpyEl = document.getElementById("usdJpy");
  const eurJpyEl = document.getElementById("eurJpy");
  const mufgLink = document.getElementById("mufgLink");

  const taxCheckEl = document.getElementById("taxCheck");
  const profitEl = document.getElementById("profit");
  const shipEl = document.getElementById("ship");
  const dutyEl = document.getElementById("duty");

  const bidLimitEl = document.getElementById("bidLimit");
  const copyMsgEl = document.getElementById("copyMsg");

  const grossHintEl = document.getElementById("grossHint");
  const bMarketEl = document.getElementById("bMarket");
  const bGrossEl = document.getElementById("bGross");
  const bFeeEl = document.getElementById("bFee");
  const bPayoutEl = document.getElementById("bPayout");
  const bShipEl = document.getElementById("bShip");
  const bDutyEl = document.getElementById("bDuty");
  const bBidEl = document.getElementById("bBid");
  const bProfitEl = document.getElementById("bProfit");

  const errMsgEl = document.getElementById("errMsg");
  const copyAllBtn = document.getElementById("copyAllBtn");
  const copyAllMsg = document.getElementById("copyAllMsg");

  // ===== state =====
  let active = localStorage.getItem(K.active) || "JPY";
  let autoCurrencyByMarket = true; // ②変更時に通貨を自動選択（その後手動変更OK）

  // ===== helpers =====
  const parseNum = (v) => {
    const s = String(v ?? "").replace(/[¥$€,\s]/g, "").replace(/[^\d.-]/g, "");
    return s ? Number(s) : NaN;
  };

  const fmtJPY = (n) => isFinite(n) ? ("¥" + Math.round(n).toLocaleString()) : "—";
  const fmtCur = (cur, n) => {
    if (!isFinite(n)) return "—";
    const opt = { style:"currency", currency: cur };
    if (cur === "JPY") opt.maximumFractionDigits = 0;
    return new Intl.NumberFormat("ja-JP", opt).format(n);
  };

  const curSymbol = (cur) => cur === "JPY" ? "¥" : (cur === "USD" ? "$" : "€");

  const feeNoteForMarket = (m) => {
    if (m === "ebay") return "eBay：15% + Payoneer：2%";
    if (m === "catawiki") return "Catawiki：12.5% + Payoneer：2%";
    return "ヤフオク・メルカリ：10%";
  };

  const feeRateForMarket = (m) => {
    if (m === "ebay") return 0.15 + 0.02;
    if (m === "catawiki") return 0.125 + 0.02;
    return 0.10;
  };

  const marketLabel = (m) => {
    if (m === "ebay") return "ebay";
    if (m === "catawiki") return "catawiki";
    return "ヤフオク・メルカリ";
  };

  const setRateInputStyle = (el) => {
    el.classList.toggle("filled", (el.value || "").trim() !== "");
  };

  const setActive = (cur, {fromAuto=false} = {}) => {
    active = cur;
    localStorage.setItem(K.active, cur);

    chips.forEach(b => b.classList.toggle("active", b.dataset.cur === cur));
    amountPrefix.textContent = curSymbol(cur);

    if (cur === "JPY") fxNeedHint.textContent = "※ JPY入力の場合は為替レート不要です";
    else if (cur === "USD") fxNeedHint.textContent = "※ USD入力の場合は「1 USD = JPY」が必要です";
    else fxNeedHint.textContent = "※ EUR入力の場合は「1 EUR = JPY」が必要です";

    // 手動で通貨を変えたら、以後は「販売先変更での自動通貨変更」は維持するが、
    // 直近の意思として記録しておく（MUFG戻りフォーカス用）
    if (!fromAuto) {
      if (cur === "USD" || cur === "EUR") localStorage.setItem(K.lastFxFocus, cur);
    }

    calc();
  };

  const toJPY = (amount, cur, usdJpy, eurJpy) => {
    if (cur === "JPY") return amount;
    if (cur === "USD") return amount * usdJpy;
    return amount * eurJpy;
  };

  const taxStatusLabel = (taxOn) => taxOn ? "消費税10％ ON / ストア" : "消費税10％ OFF / 個人";

  const buildCopyText = (state) => {
    const lines = [];
    lines.push("Bid Limit Calculator");
    lines.push(`販売先　${state.marketLabel}`);
    lines.push(`売価　　${state.priceLine}`);
    lines.push(`手数料　${fmtJPY(state.feeJpy)}（${state.feeNote}）`);
    lines.push(`入金額　${fmtJPY(state.payoutJpy)}`);
    lines.push(`送料　　${fmtJPY(state.shipJpy)}`);
    lines.push(`関税　　${fmtJPY(state.dutyJpy)}`);
    lines.push(`仕入（入札上限）${fmtJPY(state.bidJpy)}（${taxStatusLabel(state.taxOn)}）`);
    lines.push(`利益　　${fmtJPY(state.profitJpy)}`);
    return lines.join("\n");
  };

  // ===== restore =====
  const restore = () => {
    const m = localStorage.getItem(K.market);
    if (m) marketEl.value = m;

    const a = localStorage.getItem(K.amount);
    if (a) amountEl.value = a;

    const uj = localStorage.getItem(K.usdJpy);
    if (uj) usdJpyEl.value = uj;

    const ej = localStorage.getItem(K.eurJpy);
    if (ej) eurJpyEl.value = ej;

    const p = localStorage.getItem(K.profit);
    if (p !== null) profitEl.value = p;

    const s = localStorage.getItem(K.ship);
    if (s !== null) shipEl.value = s;

    const d = localStorage.getItem(K.duty);
    if (d !== null) dutyEl.value = d;

    const t = localStorage.getItem(K.tax);
    if (t !== null) taxCheckEl.checked = (t === "1");

    setRateInputStyle(usdJpyEl);
    setRateInputStyle(eurJpyEl);

    feeNoteEl.textContent = feeNoteForMarket(marketEl.value);
  };

  // ===== MUFG戻りフォーカス =====
  const focusFxAfterReturn = () => {
    // 直近の売価通貨がUSD/EURならそれを優先、そうでなければ lastFxFocus（USD/EUR）、
    // それもなければUSDにフォーカス
    const last = localStorage.getItem(K.lastFxFocus);
    const target =
      (active === "USD" || active === "EUR") ? active :
      (last === "EUR" ? "EUR" : "USD");

    const el = (target === "EUR") ? eurJpyEl : usdJpyEl;
    // iOS/Androidでも気持ちよく
    setTimeout(() => el.focus(), 0);
  };

  // MUFGボタン押下時に「戻った時フォーカスしたい」意思を保存
  mufgLink.addEventListener("click", () => {
    // USD/EURどっちにフォーカスするかを保存（今の通貨優先）
    if (active === "EUR") localStorage.setItem(K.lastFxFocus, "EUR");
    else localStorage.setItem(K.lastFxFocus, "USD");
  });

  // ページに戻ってきたらフォーカス（visibilitychange）
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      // MUFGから戻った可能性が高いのでフォーカス
      focusFxAfterReturn();
    }
  });

  // ===== calc =====
  const calc = () => {
    errMsgEl.textContent = "";
    copyMsgEl.textContent = "";
    copyAllMsg.textContent = "";

    const market = marketEl.value;
    const feeNote = feeNoteForMarket(market);
    feeNoteEl.textContent = feeNote;

    const amount = parseNum(amountEl.value);
    const usdJpy = parseNum(usdJpyEl.value);
    const eurJpy = parseNum(eurJpyEl.value);

    const taxOn = !!taxCheckEl.checked;
    const profit = parseNum(profitEl.value) || 0;
    const ship = parseNum(shipEl.value) || 0;
    const duty = parseNum(dutyEl.value) || 0;

    // save cache
    localStorage.setItem(K.market, market);
    localStorage.setItem(K.amount, String(isFinite(amount) ? amount : ""));
    localStorage.setItem(K.tax, taxOn ? "1" : "0");
    localStorage.setItem(K.profit, String(profit));
    localStorage.setItem(K.ship, String(ship));
    localStorage.setItem(K.duty, String(duty));

    if (isFinite(usdJpy) && usdJpy > 0) localStorage.setItem(K.usdJpy, String(usdJpy));
    if (isFinite(eurJpy) && eurJpy > 0) localStorage.setItem(K.eurJpy, String(eurJpy));

    setRateInputStyle(usdJpyEl);
    setRateInputStyle(eurJpyEl);

    // guard
    if (!isFinite(amount) || amount <= 0) {
      bidLimitEl.textContent = "—";
      grossHintEl.textContent = "—";
      bMarketEl.textContent = "—";
      bGrossEl.textContent = "—";
      bFeeEl.textContent = "—";
      bPayoutEl.textContent = "—";
      bShipEl.textContent = "—";
      bDutyEl.textContent = "—";
      bBidEl.textContent = "—";
      bProfitEl.textContent = "—";
      return;
    }

    // need rate?
    if (active === "USD" && (!isFinite(usdJpy) || usdJpy <= 0)) {
      errMsgEl.textContent = "USD入力の場合は「1 USD = JPY」を入力してください。";
      bidLimitEl.textContent = "—";
      return;
    }
    if (active === "EUR" && (!isFinite(eurJpy) || eurJpy <= 0)) {
      errMsgEl.textContent = "EUR入力の場合は「1 EUR = JPY」を入力してください。";
      bidLimitEl.textContent = "—";
      return;
    }

    const grossJpy = toJPY(amount, active, usdJpy, eurJpy);
    const feeRate = feeRateForMarket(market);
    const feeJpy = grossJpy * feeRate;
    const payoutJpy = grossJpy - feeJpy;

    // 仕入（入札上限）
    let bidJpy = payoutJpy - ship - duty - profit;
    if (taxOn) bidJpy = bidJpy / 1.10;

    // 売価行（レート明記）
    let rateText = "";
    if (active === "USD") rateText = `（1 USD = ${usdJpy} JPY）`;
    if (active === "EUR") rateText = `（1 EUR = ${eurJpy} JPY）`;
    const priceLine = `${fmtCur(active, amount)} → ${fmtJPY(grossJpy)} ${rateText}`.trim();

    grossHintEl.textContent = `売価（${active}）${priceLine}`;

    // 内訳表示：手数料に括弧追記
    bMarketEl.textContent = marketLabel(market);
    bGrossEl.textContent = priceLine;
    bFeeEl.textContent = `${fmtJPY(feeJpy)}（${feeNote}）`;
    bPayoutEl.textContent = fmtJPY(payoutJpy);
    bShipEl.textContent = fmtJPY(ship);
    bDutyEl.textContent = fmtJPY(duty);
    bBidEl.textContent = fmtJPY(bidJpy);
    bProfitEl.textContent = fmtJPY(profit);

    // 仕入（入札上限）表示（青字）
    bidLimitEl.textContent = fmtJPY(bidJpy);
    bidLimitEl.dataset.copyValue = String(Math.round(bidJpy));

    // コピーテキスト（指定フォーマット＋手数料括弧付き）
    const copyText = buildCopyText({
      marketLabel: marketLabel(market),
      priceLine,
      feeJpy,
      feeNote,
      payoutJpy,
      shipJpy: ship,
      dutyJpy: duty,
      bidJpy,
      taxOn,
      profitJpy: profit,
    });
    bidLimitEl.dataset.copyText = copyText;
  };

  // ===== events =====
  chips.forEach(b => b.addEventListener("click", () => setActive(b.dataset.cur)));

  // ②販売先変更 → ③通貨を自動選択（その後手動変更OK）
  marketEl.addEventListener("change", () => {
    const m = marketEl.value;
    // 指定：ヤフメル→JPY / catawiki→EUR / ebay→JPY
    const autoCur = (m === "catawiki") ? "EUR" : "JPY";
    setActive(autoCur, {fromAuto:true});
    // フォーカス用の記録も更新（USD/EURのみ）
    if (autoCur === "EUR") localStorage.setItem(K.lastFxFocus, "EUR");
    calc();
  });

  [amountEl, usdJpyEl, eurJpyEl, profitEl, shipEl, dutyEl, taxCheckEl].forEach(el => {
    el.addEventListener("input", calc);
    el.addEventListener("change", calc);
  });

  // 為替欄を触ったら、戻りフォーカス先を更新
  usdJpyEl.addEventListener("focus", () => localStorage.setItem(K.lastFxFocus, "USD"));
  eurJpyEl.addEventListener("focus", () => localStorage.setItem(K.lastFxFocus, "EUR"));
  usdJpyEl.addEventListener("input", () => localStorage.setItem(K.lastFxFocus, "USD"));
  eurJpyEl.addEventListener("input", () => localStorage.setItem(K.lastFxFocus, "EUR"));

  // タップで「仕入（入札上限）」数値のみコピー
  bidLimitEl.addEventListener("click", async () => {
    const v = bidLimitEl.dataset.copyValue;
    if (!v) return;
    try{
      await navigator.clipboard.writeText(v);
      copyMsgEl.textContent = "コピーしました（仕入 / 入札上限）";
      setTimeout(()=>copyMsgEl.textContent="",1200);
    }catch{
      copyMsgEl.textContent = "コピーに失敗しました（ブラウザ制限の可能性）";
    }
  });

  // 結果をコピー（指定フォーマット）
  copyAllBtn.addEventListener("click", async () => {
    const text = bidLimitEl.dataset.copyText;
    if (!text) return;
    try{
      await navigator.clipboard.writeText(text);
      copyAllMsg.textContent = "コピーしました";
      setTimeout(()=>copyAllMsg.textContent="",1200);
    }catch{
      copyAllMsg.textContent = "コピーに失敗しました（ブラウザ制限の可能性）";
    }
  });

  // init
  restore();
  setActive(active);
  // 初回も「市場→通貨」自動合わせを反映したいので一度 market change を踏む
  // ただし既に手動で通貨を記憶しているケースもあるので、初回は market の推奨通貨を優先
  const initMarket = marketEl.value;
  const initCur = (initMarket === "catawiki") ? "EUR" : "JPY";
  setActive(initCur, {fromAuto:true});

  calc();
})();
</script>
</body>
</html>
