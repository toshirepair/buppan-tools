<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bid Limit Calculator</title>
<style>
  *{ box-sizing:border-box; }
  body{
    font-family: system-ui,-apple-system,"Segoe UI",sans-serif;
    background:#fff;
    margin:0;
    padding:16px;
  }
  .wrap{ max-width:760px; margin:auto; }
  h1{ font-size:1.35rem; margin:0 0 12px; }

  .card{
    border:1px solid #ddd;
    border-radius:14px;
    padding:14px;
    margin-bottom:12px;
    background:#fff;
  }

  /* 入札上限：上部固定 */
  .stickyTop{
    position: sticky;
    top: 10px;
    z-index: 50;
    box-shadow: 0 8px 18px rgba(0,0,0,.06);
  }

  .k{ font-size:.85rem; color:#666; }
  .kbold{ font-size:.9rem; color:#333; font-weight:800; }
  .small{ font-size:.82rem; color:#777; margin-top:6px; line-height:1.35; }
  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

  /* スマホでも2列固定 */
  .grid2Always{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
  }

  .input, select{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    margin-top:4px;
    font-size:1rem;
    background:#fff;
  }

  /* 為替・利益：デフォ薄グレー → 入力で白 */
  .softInput{
    background:#f1f1f1;
    transition: background .15s ease;
  }
  .softInput.filled{ background:#fff; }

  .chipRow{
    display:flex;
    gap:8px;
    flex-wrap:nowrap;
    overflow:hidden;
    margin-top:4px;
  }
  button.chip{
    flex:1 1 0;
    min-width:0;
    border:1px solid #ccc;
    border-radius:999px;
    padding:8px 0;
    background:#f3f3f3;
    cursor:pointer;
    white-space:nowrap;
  }
  button.chip.active{
    background:#111;
    color:#fff;
    border-color:#111;
  }

  .moneyWrap{
    display:flex;
    align-items:center;
    width:100%;
    border:1px solid #ccc;
    border-radius:10px;
    overflow:hidden;
    margin-top:4px;
    background:#fff;
  }
  .prefix{
    padding:10px 12px;
    border-right:1px solid #e5e5e5;
    color:#333;
    background:#fafafa;
    min-width:44px;
    text-align:center;
    font-weight:600;
  }
  .moneyInput{
    border:0;
    outline:none;
    width:100%;
    padding:10px 12px;
    font-size:1rem;
    background:#fff;
  }

  .v{ font-size:1.55rem; font-weight:800; margin-top:6px; }
  .bidValue{
    color:#1d4ed8;
    cursor:pointer;
    user-select:none;
    display:flex;
    align-items:baseline;
    gap:10px;
    flex-wrap:wrap;
  }
  .bidValue:active{ opacity:.7; }

  .bidSubProfit{
    font-size:.82rem;
    color:#999;
    font-weight:600;
  }

  .topBidTitle{ font-weight:800; color:#333; font-size:.95rem; }
  .topBidSub{ font-weight:500; color:#666; font-size:.85rem; margin-left:6px; }

  .btn{
    width:100%;
    padding:10px 12px;
    border-radius:10px;
    border:1px solid #ccc;
    background:#f6f6f6;
    cursor:pointer;
    margin-top:10px;
    font-size:0.95rem;
  }
  .btn:active{ opacity:.8; }

  .breakdown{
    margin-top:10px;
    border-top:1px solid #eee;
    padding-top:10px;
  }
  .line{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:4px 0;
    font-size:0.95rem;
  }
  .line .l{ color:#444; }
  .line .r{ font-weight:600; }
  .warn{ color:#b91c1c; }

  .linkBtn{
    border:1px solid #ccc;
    background:#fff;
    border-radius:10px;
    padding:9px 12px;
    cursor:pointer;
    text-decoration:none;
    display:inline-block;
    color:#111;
    font-size:.95rem;
  }
  .linkBtn:active{ opacity:.8; }

  .sectionTitle{
    font-weight:700;
    font-size:.92rem;
    color:#333;
    margin-bottom:6px;
  }

  /* 売価クリア（青文字） */
  .clearLink{
    display:inline-block;
    margin-left:10px;
    color:#1d4ed8;
    font-size:.9rem;
    font-weight:700;
    cursor:pointer;
    user-select:none;
  }
  .clearLink:active{ opacity:.7; }

  /* 折りたたみ */
  .cardHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .foldLeft{
    display:flex;
    align-items:center;
    gap:8px;
    min-width:0;
  }
  .foldBtn{
    border:1px solid #ccc;
    background:#fff;
    border-radius:10px;
    padding:4px 8px;
    cursor:pointer;
    font-size:.9rem;
    line-height:1;
  }
  .foldBtn:active{ opacity:.8; }
  .foldBody.hidden{ display:none; }
</style>
</head>
<body>
<div class="wrap">
  <h1>Bid Limit Calculator</h1>

  <!-- 上部固定：入札上限 -->
  <div class="card stickyTop">
    <div>
      <span class="topBidTitle">入札上限（Bid Limit）</span>
      <span class="topBidSub">※タップでコピー</span>
    </div>

    <!-- 数字はコピー対象、利益表示はコピー対象外（UI上のみ） -->
    <div class="v bidValue" id="bidLimitTopWrap">
      <span id="bidLimitTop">—</span>
      <span class="bidSubProfit" id="bidProfitHint"></span>
    </div>

    <div class="small" id="copyMsgTop"></div>
  </div>

  <!-- ① -->
  <div class="card">
    <div class="sectionTitle">① 販売先・通貨・売価</div>

    <div class="grid2Always" style="margin-top:6px;">
      <div>
        <div class="k">販売先</div>
        <select id="market" class="input">
          <option value="ebay">eBay</option>
          <option value="catawiki">catawiki</option>
          <option value="domestic">ヤフオク・メルカリ</option>
        </select>
      </div>

      <div>
        <div class="k">通貨</div>
        <div class="chipRow">
          <button class="chip active" data-cur="JPY">JPY</button>
          <button class="chip" data-cur="USD">USD</button>
          <button class="chip" data-cur="EUR">EUR</button>
        </div>
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:10px;">
      <div class="k" style="margin:0;">
        売価
        <span class="clearLink" id="clearAmount">クリア</span>
      </div>
    </div>

    <div class="moneyWrap">
      <div class="prefix" id="amountPrefix">¥</div>
      <input id="amount" class="moneyInput" inputmode="decimal" placeholder="例：20000">
    </div>

    <!-- 売価下：他2通貨換算（見やすく：スペース / 小数1桁 / スラッシュ） -->
    <div class="small" id="fxNeedHint"></div>
  </div>

  <!-- ②（利益・コスト設定） -->
  <div class="card" id="cardProfit">
    <div class="cardHeader">
      <div class="foldLeft">
        <button class="foldBtn" id="toggleProfit" aria-label="toggle">▼</button>
        <div class="kbold">② 利益・コスト設定</div>
      </div>
    </div>

    <div class="foldBody" id="bodyProfit">
      <div class="k" style="margin-top:8px;">
        <label>
          <input type="checkbox" id="taxCheck">
          消費税10％ ※ストア出品者から買う時に入力する
        </label>
      </div>

      <div class="grid2Always" style="margin-top:10px;">
        <div>
          <div class="k">利益（JPY）</div>
          <input id="profit" class="input softInput" inputmode="decimal" placeholder="例：10000">
        </div>
        <div>
          <div class="k">送料・関税（JPY）</div>
          <input id="ship" class="input" inputmode="decimal" value="0">
          <div class="small">※送料・関税込みの時に入力する</div>
        </div>
      </div>

      <!-- ★追加：手数料調整 / 仕入れ価格（任意・フォーカスなし） -->
      <div class="grid2Always" style="margin-top:10px;">
        <div>
          <div class="k">手数料調整（%）</div>
          <input id="feeAdjust" class="input" inputmode="decimal" placeholder="例：3 / -2">
          <div class="small">※広告費などで手数料を増減（+3で+3% / -2で-2%）</div>
        </div>
        <div>
          <div class="k">仕入れ価格（JPY）</div>
          <input id="purchase" class="input" inputmode="decimal" placeholder="例：5000">
          <div class="small">※計算結果だけ「仕入」を固定（入札上限には影響しません）</div>
        </div>
      </div>

      <div class="small">※ 入力内容は、このブラウザに自動保存されます</div>
    </div>
  </div>

  <!-- ③（為替レート） -->
  <div class="card" id="cardFx">
    <div class="cardHeader">
      <div class="foldLeft">
        <button class="foldBtn" id="toggleFx" aria-label="toggle">▼</button>
        <div class="kbold">③ 為替レート（手動入力）</div>
      </div>
      <a class="linkBtn" href="https://www.bk.mufg.jp/ippan/rate/real.html" target="_blank" rel="noopener">
        為替レートを見る（MUFG）
      </a>
    </div>

    <div class="foldBody" id="bodyFx">
      <div class="grid2Always" style="margin-top:8px;">
        <div>
          <div class="k">1 USD = JPY</div>
          <input id="usdJpy" class="input softInput" inputmode="decimal" placeholder="例：156">
        </div>
        <div>
          <div class="k">1 EUR = JPY</div>
          <input id="eurJpy" class="input softInput" inputmode="decimal" placeholder="例：183">
        </div>
      </div>

      <div class="small">※ 入力したレートは、このブラウザに自動保存されます</div>
    </div>
  </div>

  <!-- 計算結果（★折りたたみ追加） -->
  <div class="card" id="cardResult">
    <div class="cardHeader">
      <div class="foldLeft">
        <button class="foldBtn" id="toggleResult" aria-label="toggle">▼</button>
        <div class="kbold">計算結果</div>
      </div>
    </div>

    <div class="foldBody" id="bodyResult">
      <div class="breakdown" style="border-top:none; padding-top:6px;">
        <div class="line"><div class="l">販売先</div><div class="r" id="bMarket">—</div></div>
        <div class="line"><div class="l">売価</div><div class="r" id="bGross">—</div></div>
        <div class="line"><div class="l">手数料</div><div class="r" id="bFee">—</div></div>
        <div class="line"><div class="l">入金額</div><div class="r" id="bPayout">—</div></div>
        <div class="line"><div class="l">送料・関税</div><div class="r" id="bShip">—</div></div>

        <!-- ★「仕入（入札上限）」⇔「仕入」切替 -->
        <div class="line"><div class="l" id="bCostLabel">仕入（入札上限）</div><div class="r" id="bBid">—</div></div>

        <div class="line"><div class="l">利益</div><div class="r" id="bProfit">—</div></div>
        <div class="line"><div class="l">利益率</div><div class="r" id="bProfitRate">—</div></div>

        <div class="line" id="refundRow" style="display:none;">
          <div class="l">還付金</div>
          <div class="r" id="bRefund">—</div>
        </div>

        <div class="line"><div class="l">日付</div><div class="r" id="bDate">—</div></div>

        <button class="btn" id="copyAllBtn">結果をコピー</button>
        <div class="small" id="copyAllMsg"></div>

        <div class="small warn" id="errMsg"></div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const K = {
    active: "blc_active_v12",
    market: "blc_market_v12",
    amount: "blc_amount_v12",
    usdJpy: "blc_usdJpy_v12",
    eurJpy: "blc_eurJpy_v12",
    profit: "blc_profit_v12",
    ship: "blc_ship_v12",
    tax: "blc_tax_v12",
    feeAdjust: "blc_feeAdjust_v12",
    purchase: "blc_purchase_v12",

    collapseFx: "blc_collapse_fx_v12",
    collapseProfit: "blc_collapse_profit_v12",
    collapseResult: "blc_collapse_result_v12",
  };

  const chips = document.querySelectorAll(".chip");
  const amountPrefix = document.getElementById("amountPrefix");
  const amountEl = document.getElementById("amount");
  const clearAmountEl = document.getElementById("clearAmount");
  const marketEl = document.getElementById("market");
  const fxNeedHint = document.getElementById("fxNeedHint");

  // ③ FX
  const usdJpyEl = document.getElementById("usdJpy");
  const eurJpyEl = document.getElementById("eurJpy");
  const toggleFxEl = document.getElementById("toggleFx");
  const bodyFxEl = document.getElementById("bodyFx");

  // ② Profit/Cost
  const taxCheckEl = document.getElementById("taxCheck");
  const profitEl = document.getElementById("profit");
  const shipEl = document.getElementById("ship");
  const feeAdjustEl = document.getElementById("feeAdjust");
  const purchaseEl = document.getElementById("purchase");
  const toggleProfitEl = document.getElementById("toggleProfit");
  const bodyProfitEl = document.getElementById("bodyProfit");

  // Result fold
  const toggleResultEl = document.getElementById("toggleResult");
  const bodyResultEl = document.getElementById("bodyResult");

  const bidLimitTopEl = document.getElementById("bidLimitTop");
  const bidProfitHintEl = document.getElementById("bidProfitHint");
  const bidLimitTopWrapEl = document.getElementById("bidLimitTopWrap");
  const copyMsgTopEl = document.getElementById("copyMsgTop");

  const bMarketEl = document.getElementById("bMarket");
  const bGrossEl = document.getElementById("bGross");
  const bFeeEl = document.getElementById("bFee");
  const bPayoutEl = document.getElementById("bPayout");
  const bShipEl = document.getElementById("bShip");
  const bBidEl = document.getElementById("bBid");
  const bCostLabelEl = document.getElementById("bCostLabel");
  const bProfitEl = document.getElementById("bProfit");
  const bProfitRateEl = document.getElementById("bProfitRate");
  const refundRowEl = document.getElementById("refundRow");
  const bRefundEl = document.getElementById("bRefund");
  const bDateEl = document.getElementById("bDate");

  const errMsgEl = document.getElementById("errMsg");
  const copyAllBtn = document.getElementById("copyAllBtn");
  const copyAllMsg = document.getElementById("copyAllMsg");

  let active = localStorage.getItem(K.active) || "JPY";

  const parseNum = (v) => {
    const s = String(v ?? "").replace(/[¥$€,\s]/g, "").replace(/[^\d.-]/g, "");
    return s ? Number(s) : NaN;
  };

  const fmtJPY = (n) => isFinite(n) ? ("¥" + Math.round(n).toLocaleString()) : "—";

  const fmtCur = (cur, n) => {
    if (!isFinite(n)) return "—";
    const opt = { style:"currency", currency: cur };
    if (cur === "JPY") opt.maximumFractionDigits = 0;
    return new Intl.NumberFormat("ja-JP", opt).format(n);
  };

  // 売価下の換算表示：$ / € は小数1桁、スラッシュ区切り、スペース多め
  const fmtHintUSD = (n) => isFinite(n) ? `$${n.toFixed(1)}` : `$—`;
  const fmtHintEUR = (n) => isFinite(n) ? `€${n.toFixed(1)}` : `€—`;
  const fmtHintJPY = (n) => isFinite(n) ? `¥${Math.round(n).toLocaleString()}` : `¥—`;

  const curSymbol = (cur) => cur === "JPY" ? "¥" : (cur === "USD" ? "$" : "€");

  const baseFeeNoteForMarket = (m) => {
    if (m === "ebay") return "eBay：15% + Payoneer：2%";
    if (m === "catawiki") return "Catawiki：12.5% + Payoneer：2%";
    return "ヤフオク・メルカリ：10%";
  };

  const baseFeeRateForMarket = (m) => {
    if (m === "ebay") return 0.15 + 0.02;
    if (m === "catawiki") return 0.125 + 0.02;
    return 0.10;
  };

  const marketLabel = (m) => {
    if (m === "ebay") return "ebay";
    if (m === "catawiki") return "catawiki";
    return "ヤフオク・メルカリ";
  };

  const setSoftStyle = (el) => {
    el.classList.toggle("filled", (String(el.value ?? "").trim() !== ""));
  };

  const focusNext = (el) => {
    if (!el) return;
    setTimeout(() => {
      try { el.focus({ preventScroll:true }); } catch { el.focus(); }
      if (typeof el.select === "function") el.select();
    }, 0);
  };
  const isEmpty = (el) => (String(el.value ?? "").trim() === "");

  // フォーカス順：売価 → 利益 → USD → EUR（未入力のみ）
  const focusChainAfterAmount = () => {
    if (isEmpty(profitEl)) return focusNext(profitEl);
    if (isEmpty(usdJpyEl)) return focusNext(usdJpyEl);
    if (isEmpty(eurJpyEl)) return focusNext(eurJpyEl);
  };

  const setActive = (cur) => {
    active = cur;
    localStorage.setItem(K.active, cur);

    chips.forEach(b => b.classList.toggle("active", b.dataset.cur === cur));
    amountPrefix.textContent = curSymbol(cur);

    calc();
    focusNext(amountEl);
  };

  const toJPY = (amount, cur, usdJpy, eurJpy) => {
    if (cur === "JPY") return amount;
    if (cur === "USD") return amount * usdJpy;
    return amount * eurJpy;
  };

  // 売価下：他2通貨換算（表示形式指定）
  const updateCrossHint = (amount, cur, usdJpy, eurJpy) => {
    if (!isFinite(amount) || amount <= 0) {
      fxNeedHint.textContent = "";
      return;
    }

    let jpy = NaN;
    if (cur === "JPY") {
      jpy = amount;
    } else if (cur === "USD") {
      if (isFinite(usdJpy) && usdJpy > 0) jpy = amount * usdJpy;
    } else if (cur === "EUR") {
      if (isFinite(eurJpy) && eurJpy > 0) jpy = amount * eurJpy;
    }

    let usd = NaN;
    let eur = NaN;

    if (isFinite(jpy) && isFinite(usdJpy) && usdJpy > 0) usd = jpy / usdJpy;
    if (isFinite(jpy) && isFinite(eurJpy) && eurJpy > 0) eur = jpy / eurJpy;

    // 入力通貨以外を2つ表示
    let a = "", b = "";
    if (cur === "JPY") {
      a = fmtHintUSD(usd);
      b = fmtHintEUR(eur);
    } else if (cur === "USD") {
      a = fmtHintJPY(jpy);
      b = fmtHintEUR(eur);
    } else { // EUR
      a = fmtHintJPY(jpy);
      b = fmtHintUSD(usd);
    }

    fxNeedHint.textContent = `≈  ${a}  /  ${b}`;
  };

  const taxStatusLabel = (taxOn) => taxOn ? "消費税10％ ON / ストア" : "消費税10％ OFF / 個人";
  const getDateStr = () => new Date().toLocaleDateString("sv-SE");

  const feeAdjustNote = (adjPct) => {
    if (!isFinite(adjPct) || adjPct === 0) return "";
    const sign = adjPct > 0 ? "+" : "";
    return `（調整：${sign}${adjPct}%）`;
  };

  const buildFeeNote = (baseNote, adjPct) => {
    if (!isFinite(adjPct) || adjPct === 0) return baseNote;
    const sign = adjPct > 0 ? "+" : "";
    return `${baseNote} ${sign}${adjPct}%`;
  };

  const resetOutputs = () => {
    bidLimitTopEl.textContent = "—";
    bidLimitTopEl.dataset.copyValue = "";
    bidLimitTopEl.dataset.copyText = "";
    bidProfitHintEl.textContent = "";

    bMarketEl.textContent = "—";
    bGrossEl.textContent = "—";
    bFeeEl.textContent = "—";
    bPayoutEl.textContent = "—";
    bShipEl.textContent = "—";
    bCostLabelEl.textContent = "仕入（入札上限）";
    bBidEl.textContent = "—";
    bProfitEl.textContent = "—";
    bProfitRateEl.textContent = "—";
    refundRowEl.style.display = "none";
    bRefundEl.textContent = "—";
    bDateEl.textContent = "—";
  };

  const applyCollapse = () => {
    const fxCollapsed = localStorage.getItem(K.collapseFx) === "1";
    const profitCollapsed = localStorage.getItem(K.collapseProfit) === "1";
    const resultCollapsed = localStorage.getItem(K.collapseResult) === "1";

    bodyFxEl.classList.toggle("hidden", fxCollapsed);
    toggleFxEl.textContent = fxCollapsed ? "▶" : "▼";

    bodyProfitEl.classList.toggle("hidden", profitCollapsed);
    toggleProfitEl.textContent = profitCollapsed ? "▶" : "▼";

    bodyResultEl.classList.toggle("hidden", resultCollapsed);
    toggleResultEl.textContent = resultCollapsed ? "▶" : "▼";
  };

  const restore = () => {
    const m = localStorage.getItem(K.market);
    if (m) marketEl.value = m;

    const a = localStorage.getItem(K.amount);
    if (a) amountEl.value = a;

    const uj = localStorage.getItem(K.usdJpy);
    if (uj) usdJpyEl.value = uj;

    const ej = localStorage.getItem(K.eurJpy);
    if (ej) eurJpyEl.value = ej;

    const p = localStorage.getItem(K.profit);
    if (p !== null) profitEl.value = p;

    const s = localStorage.getItem(K.ship);
    if (s !== null) shipEl.value = s;

    const t = localStorage.getItem(K.tax);
    if (t !== null) taxCheckEl.checked = (t === "1");

    const fa = localStorage.getItem(K.feeAdjust);
    if (fa !== null) feeAdjustEl.value = fa;

    const pu = localStorage.getItem(K.purchase);
    if (pu !== null) purchaseEl.value = pu;

    setSoftStyle(usdJpyEl);
    setSoftStyle(eurJpyEl);
    setSoftStyle(profitEl);

    applyCollapse();
  };

  const calc = () => {
    errMsgEl.textContent = "";
    copyMsgTopEl.textContent = "";
    copyAllMsg.textContent = "";

    const market = marketEl.value;
    const baseFeeNote = baseFeeNoteForMarket(market);

    const amount = parseNum(amountEl.value);
    const usdJpy = parseNum(usdJpyEl.value);
    const eurJpy = parseNum(eurJpyEl.value);

    const taxOn = !!taxCheckEl.checked;
    const profitSetting = parseNum(profitEl.value);
    const ship = parseNum(shipEl.value) || 0;

    const feeAdjPct = parseNum(feeAdjustEl.value); // 例：3 / -2
    const purchase = parseNum(purchaseEl.value);

    // 売価下：換算表示
    updateCrossHint(amount, active, usdJpy, eurJpy);

    // cache
    localStorage.setItem(K.market, market);
    localStorage.setItem(K.amount, String(isFinite(amount) ? amount : ""));
    localStorage.setItem(K.tax, taxOn ? "1" : "0");
    localStorage.setItem(K.profit, String(isFinite(profitSetting) ? profitSetting : (profitEl.value ?? "")));
    localStorage.setItem(K.ship, String(ship));
    localStorage.setItem(K.feeAdjust, String(feeAdjustEl.value ?? ""));
    localStorage.setItem(K.purchase, String(purchaseEl.value ?? ""));

    if (isFinite(usdJpy) && usdJpy > 0) localStorage.setItem(K.usdJpy, String(usdJpy));
    if (isFinite(eurJpy) && eurJpy > 0) localStorage.setItem(K.eurJpy, String(eurJpy));

    setSoftStyle(usdJpyEl);
    setSoftStyle(eurJpyEl);
    setSoftStyle(profitEl);

    // amount未入力
    if (!isFinite(amount) || amount <= 0) {
      resetOutputs();
      return;
    }

    // 計算用レート必須（売価がUSD/EURの時）
    if (active === "USD" && (!isFinite(usdJpy) || usdJpy <= 0)) {
      errMsgEl.textContent = "USDのレート（1 USD = JPY）を入力してください。";
      resetOutputs();
      bMarketEl.textContent = marketLabel(market);
      return;
    }
    if (active === "EUR" && (!isFinite(eurJpy) || eurJpy <= 0)) {
      errMsgEl.textContent = "EURのレート（1 EUR = JPY）を入力してください。";
      resetOutputs();
      bMarketEl.textContent = marketLabel(market);
      return;
    }

    const grossJpy = toJPY(amount, active, usdJpy, eurJpy);

    // 手数料：基本 + 調整（%）
    const baseRate = baseFeeRateForMarket(market);
    const adjRate = (isFinite(feeAdjPct) ? (feeAdjPct / 100) : 0);
    const finalRate = Math.max(0, baseRate + adjRate);

    const feeJpy = grossJpy * finalRate;
    const payoutJpy = grossJpy - feeJpy;

    let rateText = "";
    if (active === "USD" && isFinite(usdJpy)) rateText = `（1 USD = ${usdJpy} JPY）`;
    if (active === "EUR" && isFinite(eurJpy)) rateText = `（1 EUR = ${eurJpy} JPY）`;
    const priceLine = `${fmtCur(active, amount)} → ${fmtJPY(grossJpy)} ${rateText}`.trim();

    const isOverseas = (market === "ebay" || market === "catawiki");
    const dateStr = getDateStr();

    // 画面表示（利益未入力でも出す。ただし入札上限は出さない）
    bMarketEl.textContent = marketLabel(market);
    bGrossEl.textContent = priceLine;

    const feeNote = buildFeeNote(baseFeeNote, isFinite(feeAdjPct) ? feeAdjPct : 0);
    bFeeEl.textContent = `${fmtJPY(feeJpy)}（${feeNote}）`;
    bPayoutEl.textContent = fmtJPY(payoutJpy);
    bShipEl.textContent = fmtJPY(ship);
    bDateEl.textContent = dateStr;

    // 仕入れ価格が入っている時：計算結果は「仕入」に置き換え
    const hasPurchase = (isFinite(purchase) && purchase > 0);

    // ---- 入札上限（上部固定）は「利益入力があるときのみ」表示（事故防止）
    // ※仕入れ価格は入札上限に影響しない（計算結果のみ反映）
    if (!isFinite(profitSetting) || profitSetting <= 0) {
      bidLimitTopEl.textContent = "—";
      bidLimitTopEl.dataset.copyValue = "";
      bidLimitTopEl.dataset.copyText = "";
      bidProfitHintEl.textContent = "";
    } else {
      bidProfitHintEl.textContent = `利益${fmtJPY(profitSetting).replace("¥","")}円`;
    }

    // ---- 入札上限計算（profitSetting必須）
    let bidJpy = NaN;
    if (isFinite(profitSetting) && profitSetting > 0) {
      bidJpy = payoutJpy - ship - profitSetting;
      if (taxOn) bidJpy = bidJpy / 1.10;

      bidLimitTopEl.textContent = fmtJPY(bidJpy);
      bidLimitTopEl.dataset.copyValue = String(Math.round(bidJpy));
    }

    // ---- 計算結果：仕入/利益の扱い
    let costShown = bidJpy;
    let profitShown = profitSetting;

    if (hasPurchase) {
      // 計算結果は仕入れ価格を優先（利益設定は無効判定）
      bCostLabelEl.textContent = "仕入";
      costShown = purchase;

      // 利益は「入金額 - 送料/関税 - 仕入」
      // ※消費税チェックは「入札上限を下げる」用として維持、ここでは反映しない（仕様通り）
      profitShown = payoutJpy - ship - purchase;
    } else {
      bCostLabelEl.textContent = "仕入（入札上限）";
      costShown = bidJpy;
      profitShown = profitSetting;
    }

    bBidEl.textContent = isFinite(costShown) ? fmtJPY(costShown) : "—";
    bProfitEl.textContent = isFinite(profitShown) ? fmtJPY(profitShown) : "—";

    const profitRate = (isFinite(profitShown) && grossJpy > 0) ? (profitShown / grossJpy) * 100 : NaN;
    const profitRateStr = isFinite(profitRate) ? `${profitRate.toFixed(1)}%` : "—";
    bProfitRateEl.textContent = profitRateStr;

    // 還付金（ebay/catawikiのみ・通貨無関係）
    refundRowEl.style.display = "none";
    bRefundEl.textContent = "—";
    let refundJpy = 0;
    if (isOverseas) {
      // 還付金は「手数料 + 仕入（= ここでは “計算結果の仕入”）」の10%
      // ※仕入れ価格がある場合はそちらを使う
      const baseCostForRefund = (hasPurchase ? purchase : bidJpy);
      if (isFinite(baseCostForRefund)) {
        refundJpy = (baseCostForRefund + feeJpy) * 0.10;
        refundRowEl.style.display = "flex";
        bRefundEl.textContent = `${fmtJPY(refundJpy)}（手数料＋仕入の10%）`;
      }
    }

    // 利益未入力なら入札上限は出さない（ただし計算結果自体は表示）
    if (!isFinite(profitSetting) || profitSetting <= 0) {
      errMsgEl.textContent = "利益（JPY）を入力してください（入札上限を表示するために必要です）。";
    } else {
      errMsgEl.textContent = "";
    }

    // コピー用テキスト（“計算結果”の仕入/利益を反映。入札上限のコピー数値は価格のみ）
    const copyCostLabel = hasPurchase ? "仕入" : "仕入（入札上限）";
    const taxLabel = taxStatusLabel(taxOn);

    const copyLines = [];
    copyLines.push("Bid Limit Calculator");
    copyLines.push(`販売先　${marketLabel(market)}`);
    copyLines.push(`売価　　${priceLine}`);
    copyLines.push(`手数料　${fmtJPY(feeJpy)}（${feeNote}）`);
    copyLines.push(`入金額　${fmtJPY(payoutJpy)}`);
    copyLines.push(`送料・関税　${fmtJPY(ship)}`);

    if (hasPurchase) {
      copyLines.push(`${copyCostLabel}　${fmtJPY(purchase)}`);
      // 入札上限の情報も残したいならここに入れるが、仕様通り「計算結果」基準でOK
    } else {
      copyLines.push(`${copyCostLabel}　${fmtJPY(bidJpy)}（${taxLabel}）`);
    }

    copyLines.push(`利益　　${fmtJPY(profitShown)}`);
    copyLines.push(`利益率　${profitRateStr}`);
    if (isOverseas && isFinite(refundJpy) && refundJpy > 0) {
      copyLines.push(`還付金　${fmtJPY(refundJpy)}（手数料＋仕入の10%）`);
    }
    copyLines.push(`日付　${dateStr}`);

    bidLimitTopEl.dataset.copyText = copyLines.join("\n");
  };

  // 折りたたみトグル
  toggleFxEl.addEventListener("click", () => {
    const now = bodyFxEl.classList.toggle("hidden");
    toggleFxEl.textContent = now ? "▶" : "▼";
    localStorage.setItem(K.collapseFx, now ? "1" : "0");
  });
  toggleProfitEl.addEventListener("click", () => {
    const now = bodyProfitEl.classList.toggle("hidden");
    toggleProfitEl.textContent = now ? "▶" : "▼";
    localStorage.setItem(K.collapseProfit, now ? "1" : "0");
  });
  toggleResultEl.addEventListener("click", () => {
    const now = bodyResultEl.classList.toggle("hidden");
    toggleResultEl.textContent = now ? "▶" : "▼";
    localStorage.setItem(K.collapseResult, now ? "1" : "0");
  });

  // events
  chips.forEach(b => b.addEventListener("click", () => setActive(b.dataset.cur)));

  marketEl.addEventListener("change", () => {
    const m = marketEl.value;
    const autoCur = (m === "catawiki") ? "EUR" : "JPY";
    active = autoCur;
    localStorage.setItem(K.active, autoCur);
    chips.forEach(btn => btn.classList.toggle("active", btn.dataset.cur === autoCur));
    amountPrefix.textContent = curSymbol(autoCur);

    calc();
    focusNext(amountEl);
  });

  // 売価入力後：利益→為替（未入力のときだけ）
  amountEl.addEventListener("change", () => { calc(); focusChainAfterAmount(); });
  amountEl.addEventListener("blur",   () => { if (!isEmpty(amountEl)) focusChainAfterAmount(); });

  // 利益入力後：為替へ（未入力のときだけ）
  profitEl.addEventListener("change", () => {
    calc();
    if (isEmpty(usdJpyEl)) return focusNext(usdJpyEl);
    if (isEmpty(eurJpyEl)) return focusNext(eurJpyEl);
  });
  profitEl.addEventListener("blur",   () => {
    if (!isEmpty(profitEl)) {
      if (isEmpty(usdJpyEl)) return focusNext(usdJpyEl);
      if (isEmpty(eurJpyEl)) return focusNext(eurJpyEl);
    }
  });

  // 為替入力後：次（未入力のときだけ）
  usdJpyEl.addEventListener("change", () => { calc(); if (isEmpty(eurJpyEl)) focusNext(eurJpyEl); });
  usdJpyEl.addEventListener("blur",   () => { if (!isEmpty(usdJpyEl) && isEmpty(eurJpyEl)) focusNext(eurJpyEl); });

  eurJpyEl.addEventListener("change", () => { calc(); });
  eurJpyEl.addEventListener("blur",   () => { calc(); });

  // 任意項目（フォーカス無し）
  feeAdjustEl.addEventListener("input", calc);
  purchaseEl.addEventListener("input", calc);

  [usdJpyEl, eurJpyEl, profitEl, shipEl, taxCheckEl, amountEl].forEach(el => {
    el.addEventListener("input", calc);
  });

  // クリア：売価を空に → 結果も消える → 売価へフォーカス
  clearAmountEl.addEventListener("click", () => {
    amountEl.value = "";
    localStorage.setItem(K.amount, "");
    calc();
    focusNext(amountEl);
  });

  // copy (bid limit number only)
  bidLimitTopWrapEl.addEventListener("click", async (e) => {
    const v = bidLimitTopEl.dataset.copyValue;
    if (!v) return;
    try{
      await navigator.clipboard.writeText(v);
      copyMsgTopEl.textContent = "コピーしました（入札上限）";
      setTimeout(()=>copyMsgTopEl.textContent="",1200);
    }catch{
      copyMsgTopEl.textContent = "コピーに失敗しました（ブラウザ制限の可能性）";
    }
  });

  // copy all
  copyAllBtn.addEventListener("click", async () => {
    const text = bidLimitTopEl.dataset.copyText;
    if (!text) {
      copyAllMsg.textContent = "利益を入力するとコピーできます";
      setTimeout(()=>copyAllMsg.textContent="",1400);
      return;
    }
    try{
      await navigator.clipboard.writeText(text);
      copyAllMsg.textContent = "コピーしました";
      setTimeout(()=>copyAllMsg.textContent="",1200);
    }catch{
      copyAllMsg.textContent = "コピーに失敗しました（ブラウザ制限の可能性）";
    }
  });

  // init
  const restore = () => {
    const m = localStorage.getItem(K.market);
    if (m) marketEl.value = m;

    const a = localStorage.getItem(K.amount);
    if (a) amountEl.value = a;

    const uj = localStorage.getItem(K.usdJpy);
    if (uj) usdJpyEl.value = uj;

    const ej = localStorage.getItem(K.eurJpy);
    if (ej) eurJpyEl.value = ej;

    const p = localStorage.getItem(K.profit);
    if (p !== null) profitEl.value = p;

    const s = localStorage.getItem(K.ship);
    if (s !== null) shipEl.value = s;

    const t = localStorage.getItem(K.tax);
    if (t !== null) taxCheckEl.checked = (t === "1");

    const fa = localStorage.getItem(K.feeAdjust);
    if (fa !== null) feeAdjustEl.value = fa;

    const pu = localStorage.getItem(K.purchase);
    if (pu !== null) purchaseEl.value = pu;

    setSoftStyle(usdJpyEl);
    setSoftStyle(eurJpyEl);
    setSoftStyle(profitEl);

    applyCollapse();
  };

  restore();

  // 初期通貨：販売先に連動（catawikiはEUR、それ以外JPY）
  const initMarket = marketEl.value;
  const initCur = (initMarket === "catawiki") ? "EUR" : "JPY";
  active = initCur;
  localStorage.setItem(K.active, initCur);
  chips.forEach(btn => btn.classList.toggle("active", btn.dataset.cur === initCur));
  amountPrefix.textContent = curSymbol(initCur);

  calc();
})();
</script>
</body>
</html>
