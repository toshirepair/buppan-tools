<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>eBay Hot Items Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      max-width: 900px; margin:0 auto; padding:16px; line-height:1.6;
    }
    h1{ font-size:1.4rem; margin:0 0 10px; }
    .card{ border:1px solid #ddd; border-radius:10px; padding:16px; margin-bottom:16px; }
    label{ display:block; margin-top:10px; font-weight:800; }
    input,select,textarea{
      width:100%; padding:10px; margin-top:6px; font-size:1rem;
      border-radius:8px; border:1px solid #ccc; box-sizing:border-box;
    }
    button{
      margin-top:14px; padding:10px; width:100%;
      font-size:1rem; border-radius:8px; border:none; cursor:pointer;
    }
    .btn-primary{ background:#0073e6; color:#fff; }
    .btn-secondary{ background:#eee; }
    .btn-copy{ background:#444; color:#fff; }
    .small{ font-size:.9rem; color:#555; margin-top:8px; }
    .result{ font-size:1.05rem; margin-top:10px; }

    .hot{ color:#d32f2f; font-weight:900; }
    .warm{ color:#f57c00; font-weight:900; }
    .cold{ color:#1976d2; font-weight:900; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media(max-width:720px){ .row3{ grid-template-columns:1fr; } }
    @media(max-width:640px){ .row2{ grid-template-columns:1fr; } }
  </style>
</head>
<body>

<h1>ğŸ”¥ eBay Hot Items Checker</h1>

<div class="card">
  <label>å‹ç•ª / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
  <input id="keyword" type="text" placeholder="ä¾‹ï¼šNikon 50mm F/1.4 Ai-s">

  <div class="row2">
    <div>
      <label>çŠ¶æ…‹</label>
      <select id="condition">
        <option value="USED" selected>Used</option>
        <option value="NEW">New</option>
      </select>
    </div>
    <div>
      <label>ãƒªã‚µãƒ¼ãƒæœŸé–“ï¼ˆProduct Researchç”¨ï¼‰</label>
      <select id="dayRange">
        <option value="30">30æ—¥</option>
        <option value="90" selected>90æ—¥</option>
        <option value="180">180æ—¥</option>
      </select>
    </div>
  </div>

  <div class="row2">
    <div>
      <label>USDï¼šå£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰</label>
      <input id="priceUsd" type="number" inputmode="decimal" placeholder="ä¾‹ï¼š100ï¼ˆæœªå…¥åŠ›OKï¼‰">
    </div>
    <div>
      <label>JPYï¼šå£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰</label>
      <input id="priceJpy" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š15000ï¼ˆæœªå…¥åŠ›OKï¼‰">
    </div>
  </div>

  <div class="row2">
    <div>
      <label>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆ1 USD = JPYï¼‰</label>
      <input id="fx" type="number" inputmode="decimal" placeholder="ä¾‹ï¼š150" value="150">
    </div>
    <div>
      <label>å£²ã‚Œç­‹ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼ˆÂ±%ï¼‰</label>
      <select id="range">
        <option value="2">Â±2%</option>
        <option value="5">Â±5%</option>
        <option value="10" selected>Â±10%</option>
        <option value="15">Â±15%</option>
        <option value="20">Â±20%</option>
        <option value="25">Â±25%</option>
      </select>
    </div>
  </div>

  <div class="row2">
    <button class="btn-primary" onclick="openProductResearch()">eBay Product Researchï¼ˆSoldï¼‰ã‚’é–‹ã</button>
    <button class="btn-secondary" onclick="openAdvancedResearch()">Advanced Researchï¼ˆSoldï¼‰ã‚’é–‹ã</button>
  </div>

  <div class="small">
    â€» Advanced Researchã¯å¸¸ã«90æ—¥ç›¸å½“ï¼ˆæœŸé–“è¨­å®šã¯åæ˜ ã—ã¾ã›ã‚“ï¼‰
  </div>
</div>

<div class="card">
  <div class="row3">
    <div>
      <label>æŒ‡å®šæœŸé–“Soldæ•°</label>
      <input id="sold" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š20">
    </div>
    <div>
      <label>Active listingsï¼ˆå‡ºå“æ•°ï¼‰</label>
      <input id="active" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š40">
    </div>
    <div>
      <label>åºƒå‘Šåˆ©ç”¨ç‡ï¼ˆPromoted listingsï¼‰</label>
      <input id="promoted" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š50ï¼ˆæœªå…¥åŠ›OKï¼‰" min="0" max="100">
    </div>
  </div>

  <button class="btn-secondary" onclick="calculate()">åˆ¤å®šã™ã‚‹</button>

  <div id="output"></div>

  <div id="copyArea" style="display:none;">
    <label style="margin-top:14px;">åˆ¤å®šçµæœï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</label>
    <textarea id="resultText" rows="16" readonly></textarea>
    <button class="btn-copy" onclick="copyResult()">åˆ¤å®šçµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    <div id="copyMsg" class="small"></div>
  </div>
</div>

<script>
  function ymd(d=new Date()){
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,"0");
    const dd=String(d.getDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }
  function fmtInt(n){ if(!isFinite(n)) return "0"; return Math.round(n).toString(); }
  function fmtMoneyUsd(n){ if(!isFinite(n)) return "$0"; return "$"+Math.round(n).toLocaleString("en-US"); }
  function fmtMoneyJpy(n){ if(!isFinite(n)) return "Â¥0"; return "Â¥"+Math.round(n).toLocaleString("ja-JP"); }
  function fmtMonths(n){
    if(!isFinite(n)) return "âˆ";
    const r=Math.round(n*10)/10;
    return (Math.abs(r-Math.round(r))<1e-9) ? String(Math.round(r)) : String(r);
  }
  function conditionIdFromSelect(v){ return v==="NEW" ? "1000" : "3000"; }
  function conditionTextFromSelect(v){ return v==="NEW" ? "New" : "Used"; }

  function isMobile(){
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent || "");
  }

  // ã‚¹ãƒãƒ›ã§eBayãŒã‚¢ãƒ—ãƒªèµ·å‹•ã—ã¦æ¡ä»¶ãŒå´©ã‚Œã‚‹å¯¾ç­–ï¼šGoogleãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµŒç”±ã§ãƒ–ãƒ©ã‚¦ã‚¶è¡¨ç¤ºã‚’ç‹™ã†
  function openPreferBrowser(url){
    const finalUrl = isMobile()
      ? `https://www.google.com/url?q=${encodeURIComponent(url)}`
      : url;

    window.open(finalUrl, "_blank", "noopener,noreferrer");
  }

  function getFx(){
    const fx = Number(document.getElementById("fx").value);
    return (isFinite(fx) && fx > 0) ? fx : 150;
  }

  function resolveCenterPrices(){
    const fx = getFx();
    const usdRaw = document.getElementById("priceUsd").value;
    const jpyRaw = document.getElementById("priceJpy").value;

    const usd = usdRaw !== "" ? Number(usdRaw) : null;
    const jpy = jpyRaw !== "" ? Number(jpyRaw) : null;

    if (usd != null && isFinite(usd) && usd > 0) {
      return { usdCenter: usd, jpyCenter: usd * fx, source: "USD", fx };
    }
    if (jpy != null && isFinite(jpy) && jpy > 0) {
      return { usdCenter: jpy / fx, jpyCenter: jpy, source: "JPY", fx };
    }
    return null;
  }

  function calcMinMax(center, rangePct){
    const min = Math.max(0, Math.floor(center * (1 - rangePct/100)));
    const max = Math.ceil(center * (1 + rangePct/100));
    return {min, max};
  }

  // Product Researchï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æç¤ºURLã«åˆã‚ã›ã¦ sorting=-avgsalespriceï¼ˆé«˜ã„é †ï¼‰
  function buildProductResearchUrl({keyword, minUsd, maxUsd, dayRange, conditionId}){
    const endDate = Date.now();
    const startDate = endDate - (Number(dayRange) * 24 * 60 * 60 * 1000);

    const params = new URLSearchParams({
      marketplace:"EBAY-US",
      keywords: keyword,
      dayRange: String(dayRange),
      endDate: String(endDate),
      startDate: String(startDate),
      categoryId:"0",
      offset:"0",
      limit:"50",
      sorting:"-avgsalesprice",
      tabName:"SOLD",
      tz:"Asia/Tokyo"
    });

    if (minUsd != null && maxUsd != null) {
      params.set("minPrice", String(minUsd));
      params.set("maxPrice", String(maxUsd));
    }
    if (conditionId) params.set("conditionId", conditionId);

    return `https://www.ebay.com/sh/research?${params.toString()}`;
  }

  // Advanced Researchï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æç¤ºURLã«åˆã‚ã›ã¦ _sop=16ï¼ˆé«˜ã„é †ï¼‰
  function buildAdvancedResearchUrl({keyword, minJpy, maxJpy, conditionId}){
    const params = new URLSearchParams({
      _nkw: keyword,
      _sacat: "0",
      _from: "R40",
      LH_Sold: "1",
      _sop: "16"
    });

    if (conditionId) params.set("LH_ItemCondition", String(conditionId));
    if (minJpy != null && maxJpy != null) {
      params.set("_udlo", String(minJpy));
      params.set("_udhi", String(maxJpy));
    }

    return `https://www.ebay.com/sch/i.html?${params.toString()}`;
  }

  function openProductResearch(){
    const keyword = document.getElementById("keyword").value.trim();
    const condSel = document.getElementById("condition").value;
    const conditionId = conditionIdFromSelect(condSel);
    const dayRange = Number(document.getElementById("dayRange").value);
    const rangePct = Number(document.getElementById("range").value);

    if(!keyword){ alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const prices = resolveCenterPrices();
    let minUsd = null, maxUsd = null;
    if (prices) {
      const mm = calcMinMax(prices.usdCenter, rangePct);
      minUsd = mm.min; maxUsd = mm.max;
    }

    const url = buildProductResearchUrl({ keyword, minUsd, maxUsd, dayRange, conditionId });
    window.__lastProductUrl = url;
    openPreferBrowser(url);
  }

  function openAdvancedResearch(){
    const keyword = document.getElementById("keyword").value.trim();
    const condSel = document.getElementById("condition").value;
    const conditionId = conditionIdFromSelect(condSel);
    const rangePct = Number(document.getElementById("range").value);

    if(!keyword){ alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const prices = resolveCenterPrices();
    let minJpy = null, maxJpy = null;
    if (prices) {
      const mm = calcMinMax(prices.jpyCenter, rangePct);
      minJpy = mm.min; maxJpy = mm.max;
    }

    const url = buildAdvancedResearchUrl({ keyword, minJpy, maxJpy, conditionId });
    window.__lastAdvancedUrl = url;
    openPreferBrowser(url);
  }

  function calculate(){
    const keyword = document.getElementById("keyword").value.trim();
    const condSel = document.getElementById("condition").value;
    const conditionText = conditionTextFromSelect(condSel);
    const conditionId = conditionIdFromSelect(condSel);
    const dayRange = Number(document.getElementById("dayRange").value);
    const rangePct = Number(document.getElementById("range").value);

    const soldRaw = document.getElementById("sold").value;
    const activeRaw = document.getElementById("active").value;
    const promotedRaw = document.getElementById("promoted").value;

    if(!keyword){ alert("ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if(soldRaw==="" || activeRaw===""){ alert("Soldæ•°ã¨Active listingsã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const sold = Number(soldRaw);
    const active = Number(activeRaw);

    const prices = resolveCenterPrices();
    const fx = getFx();

    let usdCenter=null, jpyCenter=null, mmUsd=null, mmJpy=null;
    if (prices) {
      usdCenter = prices.usdCenter;
      jpyCenter = prices.jpyCenter;
      mmUsd = calcMinMax(usdCenter, rangePct);
      mmJpy = calcMinMax(jpyCenter, rangePct);
    }

    const productUrl = window.__lastProductUrl || buildProductResearchUrl({
      keyword,
      minUsd: mmUsd ? mmUsd.min : null,
      maxUsd: mmUsd ? mmUsd.max : null,
      dayRange,
      conditionId
    });

    const advancedUrl = window.__lastAdvancedUrl || buildAdvancedResearchUrl({
      keyword,
      minJpy: mmJpy ? mmJpy.min : null,
      maxJpy: mmJpy ? mmJpy.max : null,
      conditionId
    });

    const monthlySold = (dayRange>0) ? (sold / (dayRange/30)) : 0;

    let activeAds = null;
    if(promotedRaw!==""){
      const p = Number(promotedRaw);
      if(isFinite(p) && p>=0 && p<=100){
        activeAds = active * (p/100);
      }
    }

    const effectiveActive = (activeAds==null) ? active : activeAds;
    const rotationRate = (effectiveActive>0) ? (monthlySold/effectiveActive*100) : 0;
    const inventoryMonths = (monthlySold>0) ? (effectiveActive/monthlySold) : Infinity;

    let judge="", cls="";
    if(inventoryMonths<=1.5){
      judge="ğŸ”¥ HOTï¼šã™ãã«å£²ã‚Œã‚‹å•†å“ï¼ˆç‹™ã„ç›®ï¼‰";
      cls="hot";
    } else if(inventoryMonths<=4){
      judge="ğŸŒ¤ WARMï¼šæ¯”è¼ƒçš„å£²ã‚Œã‚„ã™ã„ï¼ˆä¾¡æ ¼ãƒ»çŠ¶æ…‹æ¬¡ç¬¬ï¼‰";
      cls="warm";
    } else {
      judge="â„ COLDï¼šé•·æœŸåœ¨åº«ã«ãªã‚Šã‚„ã™ã„";
      cls="cold";
    }

    const monthlySoldInt = fmtInt(monthlySold);
    const rotationInt = fmtInt(rotationRate);
    const inventoryTxt = fmtMonths(inventoryMonths);

    const lineSold = `æŒ‡å®šæœŸé–“Soldæ•°ï¼š${fmtInt(sold)}ï¼ˆ${dayRange}æ—¥ï¼‰`;
    const lineMonthly = `æœˆé–“Soldæ•°ï¼š${monthlySoldInt}å€‹ / æœˆ`;
    const lineActiveNoAds = `ç¾åœ¨å‡ºå“æ•°ï¼š${fmtInt(active)}å€‹ï¼ˆåºƒå‘Šãªã—ï¼‰`;
    const lineActiveAds = (activeAds==null) ? null : `ç¾åœ¨å‡ºå“æ•°ï¼š${fmtInt(activeAds)}å€‹ï¼ˆåºƒå‘Šã‚ã‚Šï¼‰`;
    const lineRotation = `å›è»¢ç‡ï¼š${rotationInt}% / æœˆ`;
    const lineInventory = `åœ¨åº«æœŸé–“ï¼š${inventoryTxt}ãƒµæœˆ`;

    let html = `<div class="result">${lineSold}<br>${lineMonthly}<br>${lineActiveNoAds}`;
    if(lineActiveAds) html += `<br>${lineActiveAds}`;
    html += `<br>${lineRotation}<br>${lineInventory}</div>`;
    html += `<div class="result"><span style="font-weight:900;">åˆ¤å®šçµæœï¼š</span><span class="${cls}" style="font-weight:900;">${judge}</span></div>`;
    document.getElementById("output").innerHTML = html;

    const today = ymd(new Date());
    const lines=[];
    lines.push("eBay Hot Items Checker");
    lines.push(`â– ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${keyword}`);
    lines.push(`çŠ¶æ…‹ï¼š${conditionText}`);

    if (usdCenter != null && jpyCenter != null && mmUsd && mmJpy) {
      lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ï¼š${fmtMoneyUsd(usdCenter)} / ${fmtMoneyJpy(jpyCenter)}`);
      lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼šÂ±${rangePct}%ï¼ˆ${fmtMoneyUsd(mmUsd.min)} - ${fmtMoneyUsd(mmUsd.max)} / ${fmtMoneyJpy(mmJpy.min)} - ${fmtMoneyJpy(mmJpy.max)}ï¼‰`);
      lines.push(`ç‚ºæ›¿ï¼š1 USD = ${fx} JPY`);
    } else {
      lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ï¼š`);
      lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼šÂ±${rangePct}%ï¼ˆï¼‰`);
      lines.push(`ç‚ºæ›¿ï¼š1 USD = ${fx} JPY`);
    }

    lines.push(`æœŸé–“ï¼š${dayRange}æ—¥`);
    lines.push(`Soldï¼š${fmtInt(sold)}å€‹`);
    lines.push(`æœˆæ›ç®— Soldï¼š${monthlySoldInt}å€‹ / æœˆ`);
    lines.push(`Active listingsï¼š${fmtInt(active)}å€‹ï¼ˆåºƒå‘Šãªã—ï¼‰`);
    if(activeAds!=null) lines.push(`Active listingsï¼š${fmtInt(activeAds)}å€‹ï¼ˆåºƒå‘Šã‚ã‚Šï¼‰`);
    lines.push(`å›è»¢ç‡ï¼š${rotationInt}% / æœˆ`);
    lines.push(`åœ¨åº«æœŸé–“ï¼š${inventoryTxt}ãƒµæœˆ`);
    lines.push(`åˆ¤å®šçµæœï¼š${judge}`);
    lines.push(`Product Research URLï¼š${productUrl}`);
    lines.push(`Advanced Research URLï¼š${advancedUrl}`);
    lines.push(`æ—¥ä»˜ï¼š${today}`);

    document.getElementById("resultText").value = lines.join("\n");
    document.getElementById("copyArea").style.display = "block";
    document.getElementById("copyMsg").textContent = "";
  }

  async function copyResult(){
    const txt=document.getElementById("resultText").value;
    try{
      await navigator.clipboard.writeText(txt);
      document.getElementById("copyMsg").textContent="ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
    }catch(e){
      const ta=document.getElementById("resultText");
      ta.focus(); ta.select();
      document.getElementById("copyMsg").textContent="ç›´æ¥ã‚³ãƒ”ãƒ¼ã§ããªã„ãŸã‚é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸï¼ˆCtrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰";
    }
  }
</script>

</body>
</html>
