<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>eBay Hot Items Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 860px;
      margin: 0 auto;
      padding: 16px;
      line-height: 1.6;
    }
    h1 { font-size: 1.4rem; margin: 0 0 4px; }
    .sub { color: #555; font-size: 0.9rem; margin-bottom: 16px; }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    label { display: block; margin-top: 10px; font-weight: 700; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 14px;
      padding: 10px;
      width: 100%;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .btn-primary { background: #0073e6; color: #fff; }
    .btn-secondary { background: #eee; }
    .btn-copy { background: #444; color: #fff; }

    .small { font-size: 0.9rem; color: #555; margin-top: 8px; }
    .result { font-size: 1.05rem; margin-top: 10px; }
    .hot { color: #d32f2f; font-weight: 800; }
    .warm { color: #f57c00; font-weight: 800; }
    .cold { color: #1976d2; font-weight: 800; }

    .kv {
      background: #fafafa;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      word-break: break-all;
    }
    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 640px) {
      .row2 { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<h1>ğŸ”¥ eBay Hot Items Checker</h1>
<div class="sub">ä»Šã®éœ€è¦ Ã— ä¾›çµ¦ã§ã€Œç‹™ã„ç›®ã€ã‹ã‚’è¦‹æ¥µã‚ã‚‹ãƒ„ãƒ¼ãƒ«ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãªã—ï¼‰</div>

<div class="card">
  <label>â‘  å‹ç•ª / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
  <input id="keyword" type="text" placeholder="ä¾‹ï¼šD750 / Nikon D750">

  <div class="row2">
    <div>
      <label>â‘¡ å£²ã‚Œç­‹ã ã¨æ€ã†ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ / USDï¼‰</label>
      <input id="price" type="number" inputmode="decimal" placeholder="ä¾‹ï¼š800">
    </div>
    <div>
      <label>â‘¢ ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼ˆÂ±%ï¼‰</label>
      <select id="range">
        <option value="5">Â±5%</option>
        <option value="10" selected>Â±10%</option>
        <option value="15">Â±15%</option>
        <option value="20">Â±20%</option>
        <option value="25">Â±25%</option>
      </select>
    </div>
  </div>

  <label>â‘£ ãƒªã‚µãƒ¼ãƒæœŸé–“</label>
  <select id="dayRange">
    <option value="30">30æ—¥</option>
    <option value="90" selected>90æ—¥</option>
    <option value="180">180æ—¥</option>
  </select>

  <button class="btn-primary" onclick="openProductResearch()">eBay Product Researchï¼ˆSoldï¼‰ã‚’é–‹ã</button>

  <div class="small">
    â€» Product Researchç”»é¢ã§ã€ŒSoldæ•°ã€ã€Œå‡ºå“æ•°ã€ã‚’ç¢ºèªã—ã¦ã€ä¸‹ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯ã‚³ãƒ”ãƒšæŠ½å‡ºã‚’å¾Œã§è¿½åŠ å¯èƒ½ï¼‰
  </div>

  <div id="generatedUrlBox" class="kv" style="display:none;"></div>
</div>

<div class="card">
  <div class="row2">
    <div>
      <label>â‘¤ æŒ‡å®šæœŸé–“ã§å£²ã‚ŒãŸæ•°ï¼ˆSoldï¼‰</label>
      <input id="sold" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š30">
    </div>
    <div>
      <label>â‘¥ ç¾åœ¨ã®å‡ºå“æ•°ï¼ˆActive listingsï¼‰</label>
      <input id="active" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š10">
    </div>
  </div>

  <button class="btn-secondary" onclick="calculate()">åˆ¤å®šã™ã‚‹</button>

  <div id="output"></div>

  <div id="copyArea" style="display:none;">
    <label style="margin-top:14px;">åˆ¤å®šçµæœï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</label>
    <textarea id="resultText" rows="10" readonly></textarea>
    <button class="btn-copy" onclick="copyResult()">åˆ¤å®šçµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    <div id="copyMsg" class="small"></div>
  </div>
</div>

<script>
  function ymd(d = new Date()) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function buildProductResearchUrl({keyword, minPrice, maxPrice, dayRange}) {
    const endDate = Date.now(); // ms
    const startDate = endDate - (Number(dayRange) * 24 * 60 * 60 * 1000);

    // å‚è€ƒURLã«åˆã‚ã›ã¦ã‚¯ã‚¨ãƒªã‚’æ§‹ç¯‰ï¼ˆtabName=SOLDã€sorting=-avgsalespriceã€tz=Asia/Tokyoï¼‰
    const params = new URLSearchParams({
      marketplace: "EBAY-US",
      keywords: keyword,
      dayRange: String(dayRange),
      endDate: String(endDate),
      startDate: String(startDate),
      categoryId: "0",
      minPrice: String(minPrice),
      maxPrice: String(maxPrice),
      offset: "0",
      limit: "50",
      sorting: "-avgsalesprice",
      tabName: "SOLD",
      tz: "Asia/Tokyo"
    });

    return `https://www.ebay.com/sh/research?${params.toString()}`;
  }

  function openProductResearch() {
    const keyword = document.getElementById("keyword").value.trim();
    const price = Number(document.getElementById("price").value);
    const range = Number(document.getElementById("range").value);
    const dayRange = Number(document.getElementById("dayRange").value);

    if (!keyword) { alert("â‘  å‹ç•ª / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (!price || price <= 0) { alert("â‘¡ ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const minPrice = Math.max(0, Math.floor(price * (1 - range / 100)));
    const maxPrice = Math.ceil(price * (1 + range / 100));

    const url = buildProductResearchUrl({ keyword, minPrice, maxPrice, dayRange });

    // è¡¨ç¤ºç”¨
    const box = document.getElementById("generatedUrlBox");
    box.style.display = "block";
    box.innerHTML = `
      <b>ç”Ÿæˆã—ãŸProduct Research URLï¼š</b><br>
      ${url}<br>
      <span class="small">ï¼ˆä¾¡æ ¼ç¯„å›²ï¼š${minPrice} - ${maxPrice} USD / æœŸé–“ï¼š${dayRange}æ—¥ï¼‰</span>
    `;

    // å¾Œã§åˆ¤å®šæ¬„ã«å…¥ã‚Œã‚‹ãŸã‚ä¿æŒ
    window.__lastResearchUrl = url;
    window.__lastMinPrice = minPrice;
    window.__lastMaxPrice = maxPrice;

    window.open(url, "_blank");
  }

  function calculate() {
    const keyword = document.getElementById("keyword").value.trim();
    const price = Number(document.getElementById("price").value);
    const range = Number(document.getElementById("range").value);
    const dayRange = Number(document.getElementById("dayRange").value);
    const soldRaw = document.getElementById("sold").value;
    const activeRaw = document.getElementById("active").value;

    if (!keyword) { alert("â‘  å‹ç•ª / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (!price || price <= 0) { alert("â‘¡ ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (soldRaw === "" || activeRaw === "") { alert("â‘¤ Soldæ•° ã¨ â‘¥ å‡ºå“æ•° ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const sold = Number(soldRaw);
    const active = Number(activeRaw);

    const minPrice = (window.__lastMinPrice != null)
      ? window.__lastMinPrice
      : Math.max(0, Math.floor(price * (1 - range / 100)));

    const maxPrice = (window.__lastMaxPrice != null)
      ? window.__lastMaxPrice
      : Math.ceil(price * (1 + range / 100));

    const researchUrl = window.__lastResearchUrl
      ? window.__lastResearchUrl
      : buildProductResearchUrl({ keyword, minPrice, maxPrice, dayRange });

    // æœˆæ›ç®—ï¼š30æ—¥ã‚’1ã‹æœˆã¨ã—ã¦æ›ç®—
    const monthlySales = (dayRange > 0) ? (sold / (dayRange / 30)) : 0;

    // å¸åæœˆæ•°ï¼šå‡ºå“æ•° / æœˆé–“è²©å£²ãƒšãƒ¼ã‚¹
    const absorptionMonths = (monthlySales > 0) ? (active / monthlySales) : Infinity;

    // åˆ¤å®š
    let judge = "";
    let cls = "";
    if (absorptionMonths <= 1.5) {
      judge = "ğŸ”¥ HOTï¼šå›è»¢ãŒéå¸¸ã«è‰¯ã„ï¼ˆç‹™ã„ç›®ï¼‰";
      cls = "hot";
    } else if (absorptionMonths <= 4) {
      judge = "ğŸŒ¤ WARMï¼šæ¡ä»¶æ¬¡ç¬¬ã§OKï¼ˆä¾¡æ ¼ãƒ»çŠ¶æ…‹å‹è² ï¼‰";
      cls = "warm";
    } else {
      judge = "â„ COLDï¼šå¯ã‚‹å¯èƒ½æ€§ãŒé«˜ã„";
      cls = "cold";
    }

    // è¡¨ç¤º
    const today = ymd(new Date());

    const outputHtml = `
      <div class="result">
        <b>æœˆæ›ç®—ã®å£²ã‚ŒãŸæ•°ï¼š</b> ${isFinite(monthlySales) ? monthlySales.toFixed(2) : "0.00"} å€‹ / æœˆ<br>
        <b>å‡ºå“å¸åç›®å®‰ï¼š</b> ${isFinite(absorptionMonths) ? absorptionMonths.toFixed(1) : "âˆ"} ã‹æœˆ
      </div>
      <div class="result ${cls}">
        <b>åˆ¤å®šï¼š</b> ${judge}
      </div>

      <div class="kv">
        <b>å…¥åŠ›ã‚µãƒãƒªãƒ¼ï¼ˆâ‘ ã€œâ‘¥ï¼‹URLï¼‹æ—¥ä»˜ï¼‰</b><br>
        â‘  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${escapeHtml(keyword)}<br>
        â‘¡ ä¸­å¿ƒä¾¡æ ¼ï¼š${price} USD<br>
        â‘¢ ãƒ¬ãƒ³ã‚¸ï¼šÂ±${range}%ï¼ˆ${minPrice} - ${maxPrice} USDï¼‰<br>
        â‘£ æœŸé–“ï¼š${dayRange}æ—¥<br>
        â‘¤ Soldï¼š${sold}<br>
        â‘¥ Activeï¼š${active}<br>
        URLï¼š${researchUrl}<br>
        æ—¥ä»˜ï¼š${today}
      </div>
    `;

    document.getElementById("output").innerHTML = outputHtml;

    // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
    const text =
`ã€eBay Hot Items Checker åˆ¤å®šã€‘
â‘  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${keyword}
â‘¡ ä¸­å¿ƒä¾¡æ ¼ï¼š${price} USD
â‘¢ ãƒ¬ãƒ³ã‚¸ï¼šÂ±${range}%ï¼ˆ${minPrice} - ${maxPrice} USDï¼‰
â‘£ æœŸé–“ï¼š${dayRange}æ—¥
â‘¤ Soldï¼š${sold}
â‘¥ Activeï¼š${active}
æœˆæ›ç®—ã®å£²ã‚ŒãŸæ•°ï¼š${isFinite(monthlySales) ? monthlySales.toFixed(2) : "0.00"} å€‹ / æœˆ
å‡ºå“å¸åç›®å®‰ï¼š${isFinite(absorptionMonths) ? absorptionMonths.toFixed(1) : "âˆ"} ã‹æœˆ
åˆ¤å®šï¼š${judge}
URLï¼š${researchUrl}
æ—¥ä»˜ï¼š${today}`;

    document.getElementById("resultText").value = text;
    document.getElementById("copyArea").style.display = "block";
    document.getElementById("copyMsg").textContent = "";
  }

  async function copyResult() {
    const txt = document.getElementById("resultText").value;
    try {
      await navigator.clipboard.writeText(txt);
      document.getElementById("copyMsg").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
    } catch (e) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šé¸æŠã—ã¦ã‚³ãƒ”ãƒ¼
      const ta = document.getElementById("resultText");
      ta.focus();
      ta.select();
      document.getElementById("copyMsg").textContent = "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç›´æ¥ã‚³ãƒ”ãƒ¼ã§ããªã„ãŸã‚ã€é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸï¼ˆCtrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰";
    }
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, function(m) {
      return ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      })[m];
    });
  }
</script>

</body>
</html>
