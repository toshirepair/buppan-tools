<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>eBay Hot Items Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 860px;
      margin: 0 auto;
      padding: 16px;
      line-height: 1.6;
    }
    h1 { font-size: 1.4rem; margin: 0 0 4px; }
    .sub { color: #555; font-size: 0.9rem; margin-bottom: 16px; }

    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    label { display: block; margin-top: 10px; font-weight: 800; }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 14px;
      padding: 10px;
      width: 100%;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .btn-primary { background: #0073e6; color: #fff; }
    .btn-secondary { background: #eee; }
    .btn-copy { background: #444; color: #fff; }

    .small { font-size: 0.9rem; color: #555; margin-top: 8px; }
    .result { font-size: 1.05rem; margin-top: 10px; }

    .hot { color: #d32f2f; font-weight: 900; }
    .warm { color: #f57c00; font-weight: 900; }
    .cold { color: #1976d2; font-weight: 900; }

    .kv {
      background: #fafafa;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      word-break: break-word;
    }
    .row2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .row3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 720px) {
      .row3 { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .row2 { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

<h1>ğŸ”¥ eBay Hot Items Checker</h1>
<div class="sub">ä»Šã®éœ€è¦ Ã— ä¾›çµ¦ã§ã€Œç‹™ã„ç›®ã€ã‹ã‚’è¦‹æ¥µã‚ã‚‹ãƒ„ãƒ¼ãƒ«ï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãªã—ï¼‰</div>

<div class="card">
  <label>â‘  å‹ç•ª / ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
  <input id="keyword" type="text" placeholder="ä¾‹ï¼šD750 / Tamron 70-180mm f/2.8 Sony E Di III VXD">

  <div class="row2">
    <div>
      <label>â‘¡ å£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ / USDï¼‰</label>
      <input id="price" type="number" inputmode="decimal" placeholder="ä¾‹ï¼š750">
    </div>
    <div>
      <label>â‘¢ å£²ã‚Œç­‹ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼ˆÂ±%ï¼‰</label>
      <select id="range">
        <option value="5">Â±5%</option>
        <option value="10" selected>Â±10%</option>
        <option value="15">Â±15%</option>
        <option value="20">Â±20%</option>
        <option value="25">Â±25%</option>
      </select>
    </div>
  </div>

  <label>â‘£ ãƒªã‚µãƒ¼ãƒæœŸé–“</label>
  <select id="dayRange">
    <option value="30">30æ—¥</option>
    <option value="90" selected>90æ—¥</option>
    <option value="180">180æ—¥</option>
  </select>

  <button class="btn-primary" onclick="openProductResearch()">eBay Product Researchï¼ˆSoldï¼‰ã‚’é–‹ã</button>

  <div class="small">
    â€» Product Researchç”»é¢ã‚’è¦‹ã¦ã€Œâ‘¤ Soldæ•°ã€ã€Œâ‘¥ Active listingsã€ã€Œâ‘¦ åºƒå‘Šåˆ©ç”¨ç‡ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆURLã¯ã‚³ãƒ”ãƒ¼æ–‡ã«ã®ã¿å«ã‚ã¾ã™ï¼‰
  </div>
</div>

<div class="card">
  <div class="row3">
    <div>
      <label>â‘¤ æŒ‡å®šæœŸé–“Soldæ•°</label>
      <input id="sold" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š45">
    </div>
    <div>
      <label>â‘¥ Active listingsï¼ˆå‡ºå“æ•°ï¼‰</label>
      <input id="active" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š34">
    </div>
    <div>
      <label>â‘¦ åºƒå‘Šåˆ©ç”¨ç‡ï¼ˆPromoted listingsï¼‰</label>
      <input id="promoted" type="number" inputmode="numeric" placeholder="ä¾‹ï¼š50ï¼ˆæœªå…¥åŠ›OKï¼‰" min="0" max="100">
    </div>
  </div>

  <button class="btn-secondary" onclick="calculate()">åˆ¤å®šã™ã‚‹</button>

  <div id="output"></div>

  <div id="copyArea" style="display:none;">
    <label style="margin-top:14px;">åˆ¤å®šçµæœï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</label>
    <textarea id="resultText" rows="14" readonly></textarea>
    <button class="btn-copy" onclick="copyResult()">åˆ¤å®šçµæœã‚’ã‚³ãƒ”ãƒ¼</button>
    <div id="copyMsg" class="small"></div>
  </div>
</div>

<script>
  function ymd(d = new Date()) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function fmtInt(n) {
    if (!isFinite(n)) return "0";
    return Math.round(n).toString();
  }

  function fmtMoney(n) {
    if (!isFinite(n)) return "$0";
    return "$" + Math.round(n).toLocaleString("en-US");
  }

  function fmtMonths(n) {
    if (!isFinite(n)) return "âˆ";
    const r = Math.round(n * 10) / 10;
    return (Math.abs(r - Math.round(r)) < 1e-9) ? String(Math.round(r)) : String(r);
  }

  function buildProductResearchUrl({keyword, minPrice, maxPrice, dayRange}) {
    const endDate = Date.now(); // ms
    const startDate = endDate - (Number(dayRange) * 24 * 60 * 60 * 1000);

    const params = new URLSearchParams({
      marketplace: "EBAY-US",
      keywords: keyword,
      dayRange: String(dayRange),
      endDate: String(endDate),
      startDate: String(startDate),
      categoryId: "0",
      minPrice: String(minPrice),
      maxPrice: String(maxPrice),
      offset: "0",
      limit: "50",
      sorting: "-avgsalesprice",
      tabName: "SOLD",
      tz: "Asia/Tokyo"
    });

    return `https://www.ebay.com/sh/research?${params.toString()}`;
  }

  function openProductResearch() {
    const keyword = document.getElementById("keyword").value.trim();
    const price = Number(document.getElementById("price").value);
    const range = Number(document.getElementById("range").value);
    const dayRange = Number(document.getElementById("dayRange").value);

    if (!keyword) { alert("â‘  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (!price || price <= 0) { alert("â‘¡ ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const minPrice = Math.max(0, Math.floor(price * (1 - range / 100)));
    const maxPrice = Math.ceil(price * (1 + range / 100));

    const url = buildProductResearchUrl({ keyword, minPrice, maxPrice, dayRange });

    // åˆ¤å®šæ™‚ã«ä½¿ã†ãŸã‚ä¿æŒ
    window.__lastResearchUrl = url;
    window.__lastMinPrice = minPrice;
    window.__lastMaxPrice = maxPrice;

    window.open(url, "_blank");
  }

  function calculate() {
    const keyword = document.getElementById("keyword").value.trim();
    const price = Number(document.getElementById("price").value);
    const range = Number(document.getElementById("range").value);
    const dayRange = Number(document.getElementById("dayRange").value);

    const soldRaw = document.getElementById("sold").value;
    const activeRaw = document.getElementById("active").value;
    const promotedRaw = document.getElementById("promoted").value;

    if (!keyword) { alert("â‘  ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (!price || price <= 0) { alert("â‘¡ ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    if (soldRaw === "" || activeRaw === "") { alert("â‘¤ Soldæ•° ã¨ â‘¥ Active listings ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

    const sold = Number(soldRaw);
    const active = Number(activeRaw);

    // ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸
    const minPrice = (window.__lastMinPrice != null)
      ? window.__lastMinPrice
      : Math.max(0, Math.floor(price * (1 - range / 100)));

    const maxPrice = (window.__lastMaxPrice != null)
      ? window.__lastMaxPrice
      : Math.ceil(price * (1 + range / 100));

    // URLï¼ˆç”»é¢è¡¨ç¤ºã¯ã—ãªã„ã€ã‚³ãƒ”ãƒ¼æ–‡ã«ã®ã¿å…¥ã‚Œã‚‹ï¼‰
    const researchUrl = window.__lastResearchUrl
      ? window.__lastResearchUrl
      : buildProductResearchUrl({ keyword, minPrice, maxPrice, dayRange });

    // æœˆé–“Soldæ•°ï¼š30æ—¥=1ã‹æœˆæ›ç®—
    const monthlySold = (dayRange > 0) ? (sold / (dayRange / 30)) : 0;

    // åºƒå‘Šã‚ã‚Šå‡ºå“æ•°ï¼ˆæœªå…¥åŠ›ãªã‚‰ nullï¼‰
    let activeAds = null;
    if (promotedRaw !== "") {
      const p = Number(promotedRaw);
      if (isFinite(p) && p >= 0 && p <= 100) {
        activeAds = active * (p / 100);
      }
    }

    // è¨ˆç®—ã¯ã€Œåºƒå‘Šã‚ã‚Šã€ãŒã‚ã‚Œã°ãã‚Œã‚’æ¡ç”¨ï¼ˆå¼·ã„ãƒ©ã‚¤ãƒãƒ«æ•°ï¼‰
    const effectiveActive = (activeAds == null) ? active : activeAds;

    // å›è»¢ç‡ï¼šæœˆé–“Sold / å‡ºå“æ•°(effective) * 100
    const rotationRate = (effectiveActive > 0) ? (monthlySold / effectiveActive * 100) : 0;

    // åœ¨åº«æœŸé–“ï¼ˆæœˆï¼‰ï¼šå‡ºå“æ•°(effective) / æœˆé–“Sold
    const inventoryMonths = (monthlySold > 0) ? (effectiveActive / monthlySold) : Infinity;

    // åˆ¤å®šï¼ˆåœ¨åº«æœŸé–“ãƒ™ãƒ¼ã‚¹ï¼‰
    let judge = "";
    let cls = "";
    if (inventoryMonths <= 1.5) {
      judge = "ğŸ”¥ HOTï¼šå›è»¢ãŒéå¸¸ã«è‰¯ã„ï¼ˆç‹™ã„ç›®ï¼‰";
      cls = "hot";
    } else if (inventoryMonths <= 4) {
      judge = "ğŸŒ¤ WARMï¼šæ¡ä»¶æ¬¡ç¬¬ã§OKï¼ˆä¾¡æ ¼ãƒ»çŠ¶æ…‹å‹è² ï¼‰";
      cls = "warm";
    } else {
      judge = "â„ COLDï¼šå¯ã‚‹å¯èƒ½æ€§ãŒé«˜ã„";
      cls = "cold";
    }

    // è¡¨ç¤ºç”¨ï¼ˆå¤ªå­—ã«ã—ãªã„ã€‚åˆ¤å®šçµæœã ã‘å¤ªå­—ï¼‰
    const monthlySoldInt = fmtInt(monthlySold);
    const rotationInt = fmtInt(rotationRate);
    const inventoryTxt = fmtMonths(inventoryMonths);

    const lineSold = `æŒ‡å®šæœŸé–“Soldæ•°ï¼š${fmtInt(sold)}ï¼ˆ${dayRange}æ—¥ï¼‰`;
    const lineMonthly = `æœˆé–“Soldæ•°ï¼š${monthlySoldInt}å€‹ / æœˆ`;
    const lineActiveNoAds = `ç¾åœ¨å‡ºå“æ•°ï¼š${fmtInt(active)}å€‹ï¼ˆåºƒå‘Šãªã—ï¼‰`;
    const lineActiveAds = (activeAds == null)
      ? null
      : `ç¾åœ¨å‡ºå“æ•°ï¼š${fmtInt(activeAds)}å€‹ï¼ˆåºƒå‘Šã‚ã‚Šï¼‰`;
    const lineRotation = `å›è»¢ç‡ï¼š${rotationInt}% / æœˆ`;
    const lineInventory = `åœ¨åº«æœŸé–“ï¼š${inventoryTxt}ãƒµæœˆ`;

    let html = `<div class="result">${lineSold}<br>${lineMonthly}<br>${lineActiveNoAds}`;
    if (lineActiveAds) html += `<br>${lineActiveAds}`;
    html += `<br>${lineRotation}<br>${lineInventory}</div>`;
    html += `<div class="result"><span style="font-weight:900;">åˆ¤å®šçµæœï¼š</span><span class="${cls}" style="font-weight:900;">${judge}</span></div>`;

    document.getElementById("output").innerHTML = html;

    // ã‚³ãƒ”ãƒ¼æ–‡ï¼ˆç©ºè¡Œãªã—ã€æŒ‡å®šã®è¡¨ç¾ã€æ—¥ä»˜ã¯æœ€å¾Œï¼‰
    const today = ymd(new Date());
    const lines = [];
    lines.push("eBay Hot Items Checker");
    lines.push(`â– ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼š${keyword}`);
    lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ï¼ˆä¸­å¿ƒå€¤ï¼‰ï¼š${fmtMoney(price)}`);
    lines.push(`å£²ã‚Œç­‹ã®ä¾¡æ ¼ãƒ¬ãƒ³ã‚¸ï¼šÂ±${range}%ï¼ˆ${fmtMoney(minPrice)} - ${fmtMoney(maxPrice)}ï¼‰`);
    lines.push(`æœŸé–“ï¼š${dayRange}æ—¥`);
    lines.push(`Soldï¼š${fmtInt(sold)}å€‹`);
    lines.push(`æœˆæ›ç®— Soldï¼š${monthlySoldInt}å€‹ / æœˆ`);
    lines.push(`Active listingsï¼š${fmtInt(active)}å€‹ï¼ˆåºƒå‘Šãªã—ï¼‰`);
    if (activeAds != null) {
      lines.push(`Active listingsï¼š${fmtInt(activeAds)}å€‹ï¼ˆåºƒå‘Šã‚ã‚Šï¼‰`);
    }
    lines.push(`å›è»¢ç‡ï¼š${rotationInt}% / æœˆ`);
    lines.push(`åœ¨åº«æœŸé–“ï¼š${inventoryTxt}ãƒµæœˆ`);
    lines.push(`åˆ¤å®šçµæœï¼š${judge}`);
    lines.push(`Product Research URLï¼š${researchUrl}`);
    lines.push(`æ—¥ä»˜ï¼š${today}`);

    document.getElementById("resultText").value = lines.join("\n");
    document.getElementById("copyArea").style.display = "block";
    document.getElementById("copyMsg").textContent = "";
  }

  async function copyResult() {
    const txt = document.getElementById("resultText").value;
    try {
      await navigator.clipboard.writeText(txt);
      document.getElementById("copyMsg").textContent = "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ âœ…";
    } catch (e) {
      const ta = document.getElementById("resultText");
      ta.focus();
      ta.select();
      document.getElementById("copyMsg").textContent =
        "ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ç›´æ¥ã‚³ãƒ”ãƒ¼ã§ããªã„ãŸã‚ã€é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸï¼ˆCtrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰";
    }
  }
</script>

</body>
</html>
